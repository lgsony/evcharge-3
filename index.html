<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EV Charge Log Pro ‚Äì v4-ODO-20251207</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
    :root{
        color-scheme: dark;
        --bg-main:#000000;
        --bg-card:#171717;
        --bg-card-soft:#1f1f1f;
        --border-soft:#333333;
        --text-main:#ffffff;
        --text-sub:#9e9e9e;
        --accent-red:#e50914;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,sans-serif;}
    body{
        background:radial-gradient(circle at top,#220000 0,#000 55%);
        color:var(--text-main);
        min-height:100vh;
    }
    .app-shell{
        max-width:900px;
        margin:0 auto;
        padding:14px 16px 40px;
    }
    .app-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:10px;
    }
    .title-wrap{
        display:flex;
        flex-direction:column;
        gap:2px;
    }
    .app-title{
        font-size:18px;
        font-weight:600;
        letter-spacing:0.02em;
    }
    .app-subtitle{
        font-size:11px;
        color:var(--text-sub);
    }
    .tesla-pill{
        padding:4px 10px;
        border-radius:999px;
        border:1px solid var(--border-soft);
        font-size:11px;
        color:var(--text-sub);
    }
    /* Add Record button */
    .add-record-btn{
        width:100%;
        margin:8px 0 16px;
        padding:14px 0;
        border-radius:16px;
        border:none;
        background:var(--accent-red);
        color:#fff;
        font-size:17px;
        font-weight:600;
        letter-spacing:0.04em;
        text-transform:uppercase;
        box-shadow:0 12px 26px rgba(229,9,20,0.35);
    }
    .add-record-btn:active{
        transform:scale(0.98);
        box-shadow:0 6px 16px rgba(0,0,0,0.6);
    }

    /* Cards */
    .card{
        background:var(--bg-card);
        border-radius:24px;
        border:1px solid var(--border-soft);
        padding:14px 16px 18px;
        margin-bottom:12px;
    }
    .card-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:8px;
    }
    .card-title{
        font-size:15px;
        font-weight:600;
    }
    .card-sub{
        font-size:11px;
        color:var(--text-sub);
    }

    /* Form */
    #recordForm{
        display:none;
        margin-top:4px;
    }
    .form-grid{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:8px 10px;
        margin-bottom:8px;
    }
    .form-row-full{
        grid-column:1 / -1;
    }
    label{
        font-size:11px;
        color:var(--text-sub);
        margin-bottom:3px;
        display:block;
    }
    input[type="date"],
    input[type="number"],
    input[type="text"]{
        width:100%;
        padding:8px 9px;
        border-radius:10px;
        border:1px solid #2e2e2e;
        background:#111111;
        color:var(--text-main);
        font-size:13px;
    }
    input[type="date"]{
        padding-right:4px;
    }
    input::placeholder{color:#555;}
    .form-actions{
        display:flex;
        justify-content:flex-end;
        gap:8px;
        margin-top:6px;
    }
    .btn-ghost{
        padding:7px 14px;
        border-radius:999px;
        border:1px solid #444;
        background:#111;
        color:var(--text-main);
        font-size:13px;
    }
    .btn-primary{
        padding:7px 16px;
        border-radius:999px;
        border:none;
        background:var(--accent-red);
        color:#fff;
        font-size:13px;
        font-weight:500;
    }
    .btn-ghost:active,.btn-primary:active{
        transform:scale(0.97);
    }

    /* Table */
    .table-wrap{
        overflow-x:auto;
        margin-top:6px;
    }
    table{
        width:100%;
        border-collapse:collapse;
        font-size:12px;
    }
    thead{
        background:linear-gradient(to bottom,#262626,#1b1b1b);
    }
    th,td{
        padding:6px 6px;
        border-bottom:1px solid #242424;
        text-align:left;
        white-space:nowrap;
    }
    th{
        font-size:11px;
        color:var(--text-sub);
        font-weight:500;
    }
    tbody tr:nth-child(even){
        background:#151515;
    }
    .text-right{text-align:right;}
    .tag-location{
        font-size:11px;
        color:var(--text-main);
    }
    .row-actions{
        display:flex;
        gap:4px;
        justify-content:center;
    }
    .icon-btn{
        background:none;
        border:none;
        font-size:15px;
        cursor:pointer;
    }

    /* Monthly Summary */
    .summary-grid{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:4px 16px;
        margin-top:4px;
        font-size:12px;
    }
    .summary-label{
        color:var(--text-sub);
        font-size:11px;
    }
    .summary-value{
        font-weight:500;
    }
    .summary-empty{
        font-size:12px;
        color:var(--text-sub);
        margin-top:4px;
    }

    /* Saved Locations */
    .locations-list{
        margin-top:6px;
        border-top:1px solid #272727;
    }
    .location-row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:6px 0;
        border-bottom:1px solid #202020;
        font-size:13px;
    }
    .location-actions{
        display:flex;
        gap:8px;
        font-size:16px;
    }
    .location-input-row{
        display:flex;
        gap:8px;
        margin-top:8px;
    }
    .location-input-row input{
        flex:1;
    }

    /* Bottom import/export row */
    .bottom-bar{
        position:static;
        width:100%;
        margin:12px 0 0;
        display:flex;
        justify-content:space-between;
        gap:12px;
        padding:0 0;
        background:transparent;
        border:none;
    }
    .bottom-btn{
        flex:1;
        padding:14px 0;
        border-radius:50px;
        background:#1f1f1f;
        color:#ffffff;
        text-align:center;
        font-size:15px;
        font-weight:500;
        border:1px solid #333;
        box-shadow:0 0 8px rgba(0,0,0,0.35);
        white-space:nowrap;
        transition:background 0.12s, transform 0.12s;
    }
    .bottom-btn:active{
        background:#2a2a2a;
        transform:scale(0.98);
    }

    .version-text{
        margin:6px 0 14px;
        text-align:center;
        font-size:11px;
        color:#666666;
    }

    .footer-link{
        display:flex;
        justify-content:center;
        margin-bottom:8px;
    }
    .chip-link{
        display:inline-block;
        padding:6px 14px;
        border-radius:999px;
        border:1px solid var(--border-soft);
        background:#141414;
        color:var(--text-sub);
        font-size:11px;
        text-decoration:none;
    }

    @media (min-width:720px){
        .form-grid{
            grid-template-columns:repeat(4,minmax(0,1fr));
        }
    }
</style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="title-wrap">
            <div class="app-title">EV Charge Log Pro</div>
            <div class="app-subtitle">Model Y Juniper RWD ¬∑ 60 kWh pack ¬∑ ODO mode</div>
        </div>
        <div class="tesla-pill">Â∞èÂ∏Ö ¬∑ v4-ODO</div>
    </header>

    <button class="add-record-btn" id="toggleFormBtn">Add Record</button>

    <!-- Add record form card -->
    <section class="card" id="formCard" style="display:none;">
        <div class="card-header">
            <div>
                <div class="card-title">New Charge Record</div>
                <div class="card-sub">Date, SOC, ODO, Location, Rate &amp; Cost</div>
            </div>
        </div>

        <form id="recordForm">
            <div class="form-grid">
                <div>
                    <label for="dateInput">Date</label>
                    <input type="date" id="dateInput">
                </div>
                <div>
                    <label for="startInput">Start %</label>
                    <input id="startInput" type="number" inputmode="numeric" pattern="\d*" min="0" max="100" placeholder="e.g. 20">
                </div>
                <div>
                    <label for="endInput">End %</label>
                    <input id="endInput" type="number" inputmode="numeric" pattern="\d*" min="0" max="100" placeholder="e.g. 80">
                </div>
                <div>
                    <label for="odoInput">ODO km</label>
                    <input id="odoInput" type="number" inputmode="numeric" pattern="\d*" min="0" placeholder="e.g. 12345">
                </div>
                <div class="form-row-full">
                    <label for="locationInput">Location</label>
                    <input id="locationInput" type="text" list="locationsDatalist" placeholder="e.g. PV-KL">
                    <datalist id="locationsDatalist"></datalist>
                </div>
                <div>
                    <label for="rateInput">Rate RM/kWh</label>
                    <input id="rateInput" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 1.25">
                </div>
                <div>
                    <label for="costInput">Cost RM</label>
                    <input id="costInput" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 25.30">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-ghost" id="cancelFormBtn">Cancel</button>
                <button type="submit" class="btn-primary">Save</button>
            </div>
        </form>
    </section>

    <!-- Monthly Summary -->
    <section class="card">
        <div class="card-header">
            <div>
                <div class="card-title">Monthly Summary (60 kWh pack)</div>
                <div class="card-sub" id="summaryMonthLabel">No drive data yet</div>
            </div>
        </div>
        <div id="summaryBody"></div>
    </section>

    <!-- Records table -->
    <section class="card">
        <div class="card-header">
            <div class="card-title">Charge Records</div>
            <div class="card-sub">Based on previous record ¬∑ v4-ODO logic</div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th class="text-right">Start</th>
                        <th class="text-right">End</th>
                        <th class="text-right">Used kWh</th>
                        <th class="text-right">KM</th>
                        <th>Location</th>
                        <th class="text-right">Rate</th>
                        <th class="text-right">Cost</th>
                        <th style="text-align:center;">Edit</th>
                        <th style="text-align:center;">Del</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                </tbody>
            </table>
        </div>
    </section>

    <!-- Saved locations -->
    <section class="card">
        <div class="card-header">
            <div class="card-title">Saved Locations</div>
            <div class="card-sub">For quick input ¬∑ editable</div>
        </div>

        <div class="location-input-row">
            <input type="text" id="newLocationInput" placeholder="Add new location (e.g. PV-D)">
            <button class="btn-primary" type="button" id="addLocationBtn">Add</button>
        </div>

        <div class="locations-list" id="locationsList">
            <!-- dynamic rows -->
        </div>
    </section>

    <!-- Import / Export row -->
    <div class="bottom-bar">
        <button id="importBtn" class="bottom-btn">Import CSV</button>
        <button id="exportBtn" class="bottom-btn">Export CSV</button>
    </div>
    <input type="file" id="importFile" accept=".csv" style="display:none;">

    <div class="version-text">Version v4-ODO-20251207</div>

    <div class="footer-link">
        <a href="https://lgsony.github.io" target="_blank" class="chip-link">lgsony.github.io</a>
    </div>
</div>

<script>
(function(){
    const BATTERY_KWH = 60;
    const STORAGE_KEY_RECORDS = "evChargeLogPro_v4_odo_records";
    const STORAGE_KEY_LOCATIONS = "evChargeLogPro_locations";

    let records = [];
    let locations = [];

    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const formCard      = document.getElementById("formCard");
    const recordForm    = document.getElementById("recordForm");
    const cancelFormBtn = document.getElementById("cancelFormBtn");

    const dateInput     = document.getElementById("dateInput");
    const startInput    = document.getElementById("startInput");
    const endInput      = document.getElementById("endInput");
    const odoInput      = document.getElementById("odoInput");
    const locationInput = document.getElementById("locationInput");
    const rateInput     = document.getElementById("rateInput");
    const costInput     = document.getElementById("costInput");

    const recordsBody   = document.getElementById("recordsBody");
    const summaryBody   = document.getElementById("summaryBody");
    const summaryMonthLabel = document.getElementById("summaryMonthLabel");

    const locationsList = document.getElementById("locationsList");
    const newLocationInput = document.getElementById("newLocationInput");
    const addLocationBtn   = document.getElementById("addLocationBtn");
    const locationsDatalist = document.getElementById("locationsDatalist");

    const importBtn  = document.getElementById("importBtn");
    const exportBtn  = document.getElementById("exportBtn");
    const importFile = document.getElementById("importFile");

    function init(){
        loadFromStorage();
        setDefaultDate();
        renderAll();
        wireEvents();
    }

    function loadFromStorage(){
        try{
            const r = localStorage.getItem(STORAGE_KEY_RECORDS);
            if(r){ records = JSON.parse(r); }
        }catch(e){ records = []; }

        try{
            const l = localStorage.getItem(STORAGE_KEY_LOCATIONS);
            if(l){ locations = JSON.parse(l); }
        }catch(e){ locations = []; }

        if(!Array.isArray(records)){ records = []; }
        if(!Array.isArray(locations)){ locations = []; }
    }

    function saveRecords(){
        localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
    }
    function saveLocations(){
        localStorage.setItem(STORAGE_KEY_LOCATIONS, JSON.stringify(locations));
    }

    function setDefaultDate(){
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth()+1).padStart(2,"0");
        const d = String(today.getDate()).padStart(2,"0");
        dateInput.value = `${y}-${m}-${d}`;
    }

    function wireEvents(){
        toggleFormBtn.addEventListener("click", () => {
            const isOpen = formCard.style.display !== "none";
            formCard.style.display = isOpen ? "none" : "block";
            if(!isOpen){
                resetForm();
                startInput.focus();
            }
        });

        cancelFormBtn.addEventListener("click", () => {
            formCard.style.display = "none";
        });

        // auto move after 2 digits
        startInput.addEventListener("input", () => {
            if(startInput.value.length >= 2){
                endInput.focus();
            }
        });
        endInput.addEventListener("input", () => {
            if(endInput.value.length >= 2){
                odoInput.focus();
            }
        });

        recordForm.addEventListener("submit", onSubmitForm);

        addLocationBtn.addEventListener("click", onAddLocation);
        newLocationInput.addEventListener("keydown", e=>{
            if(e.key==="Enter"){
                e.preventDefault();
                onAddLocation();
            }
        });

        importBtn.addEventListener("click", () => importFile.click());
        importFile.addEventListener("change", onImportFile);
        exportBtn.addEventListener("click", onExport);
    }

    function resetForm(){
        setDefaultDate();
        startInput.value="";
        endInput.value="";
        odoInput.value="";
        locationInput.value="";
        rateInput.value="";
        costInput.value="";
    }

    function onSubmitForm(e){
        e.preventDefault();
        const date = dateInput.value || "";
        const start = toNumber(startInput.value);
        const end   = toNumber(endInput.value);
        const odo   = toNumber(odoInput.value);
        const loc   = (locationInput.value || "").trim();
        const rate  = toNumber(rateInput.value);
        const cost  = toNumber(costInput.value);

        if(!date || isNaN(start) || isNaN(end) || isNaN(odo)){
            alert("Date, Start%, End%, ODO are required.");
            return;
        }

        const rec = {
            id: Date.now() + "_" + Math.random().toString(36).slice(2),
            date,
            start,
            end,
            odo,
            location: loc,
            rate,
            cost,
            driveKm:null,
            usedKwh:null,
            whPerKm:null
        };
        records.push(rec);
        recomputeDriveStats();
        saveRecords();
        renderRecords();
        renderSummary();

        if(loc && !locations.includes(loc)){
            locations.push(loc);
            saveLocations();
            renderLocations();
        }

        formCard.style.display="none";
    }

    function toNumber(v){
        if(v===undefined || v===null || v==="") return NaN;
        return Number(v);
    }

    function recomputeDriveStats(){
        if(records.length===0) return;

        // sort by date ascending but keep relative order for same date
        records.sort((a,b)=>{
            if(a.date===b.date) return 0;
            return a.date < b.date ? -1 : 1;
        });

        for(let i=0;i<records.length;i++){
            const cur = records[i];
            if(i===0){
                cur.driveKm = null;
                cur.usedKwh = null;
                cur.whPerKm = null;
                continue;
            }
            const prev = records[i-1];
            const driveKm = cur.odo - prev.odo;
            const usedKwh = BATTERY_KWH * (prev.end - cur.start) / 100;

            if(driveKm>0 && usedKwh>0){
                cur.driveKm = round(driveKm,1);
                cur.usedKwh = round(usedKwh,2);
                cur.whPerKm = round(usedKwh*1000/driveKm,1);
            }else{
                cur.driveKm = null;
                cur.usedKwh = null;
                cur.whPerKm = null;
            }
        }
    }

    function round(num,dec){
        const p = Math.pow(10,dec);
        return Math.round(num*p)/p;
    }

    function renderAll(){
        renderLocations();
        recomputeDriveStats();
        renderRecords();
        renderSummary();
    }

    function renderRecords(){
        recordsBody.innerHTML="";
        for(const rec of records){
            const tr = document.createElement("tr");

            const tdDate   = document.createElement("td");
            tdDate.textContent = formatDisplayDate(rec.date);

            const tdStart  = document.createElement("td");
            tdStart.className="text-right";
            tdStart.textContent = isNaN(rec.start) ? "" : rec.start;

            const tdEnd    = document.createElement("td");
            tdEnd.className="text-right";
            tdEnd.textContent = isNaN(rec.end) ? "" : rec.end;

            const tdUsed   = document.createElement("td");
            tdUsed.className="text-right";
            tdUsed.textContent = rec.usedKwh!=null ? rec.usedKwh.toFixed(2) : "-";

            const tdKm     = document.createElement("td");
            tdKm.className="text-right";
            tdKm.textContent = rec.driveKm!=null ? rec.driveKm.toFixed(1) : "-";

            const tdLoc    = document.createElement("td");
            tdLoc.innerHTML = `<span class="tag-location">${rec.location||""}</span>`;

            const tdRate   = document.createElement("td");
            tdRate.className="text-right";
            tdRate.textContent = rec.rate ? rec.rate.toFixed(2) : "-";

            const tdCost   = document.createElement("td");
            tdCost.className="text-right";
            tdCost.textContent = rec.cost ? rec.cost.toFixed(2) : "-";

            const tdEdit   = document.createElement("td");
            tdEdit.style.textAlign="center";
            const editBtn  = document.createElement("button");
            editBtn.className="icon-btn";
            editBtn.textContent="‚úèÔ∏è";
            editBtn.addEventListener("click",()=>editRecord(rec.id));
            tdEdit.appendChild(editBtn);

            const tdDel = document.createElement("td");
            tdDel.style.textAlign="center";
            const delBtn = document.createElement("button");
            delBtn.className="icon-btn";
            delBtn.textContent="üóëÔ∏è";
            delBtn.addEventListener("click",()=>deleteRecord(rec.id));
            tdDel.appendChild(delBtn);

            tr.appendChild(tdDate);
            tr.appendChild(tdStart);
            tr.appendChild(tdEnd);
            tr.appendChild(tdUsed);
            tr.appendChild(tdKm);
            tr.appendChild(tdLoc);
            tr.appendChild(tdRate);
            tr.appendChild(tdCost);
            tr.appendChild(tdEdit);
            tr.appendChild(tdDel);

            recordsBody.appendChild(tr);
        }
    }

    function formatDisplayDate(iso){
        if(!iso) return "";
        const [y,m,d] = iso.split("-");
        return Number(d)+"/"+Number(m)+"/"+y;
    }

    function editRecord(id){
        const idx = records.findIndex(r=>r.id===id);
        if(idx===-1) return;
        const r = records[idx];

        // open form with existing values
        formCard.style.display="block";
        dateInput.value = r.date;
        startInput.value = r.start;
        endInput.value = r.end;
        odoInput.value = r.odo;
        locationInput.value = r.location;
        rateInput.value = r.rate;
        costInput.value = r.cost;

        // override submit temporarily
        const handler = function(e){
            e.preventDefault();

            const date = dateInput.value || "";
            const start = toNumber(startInput.value);
            const end   = toNumber(endInput.value);
            const odo   = toNumber(odoInput.value);
            const loc   = (locationInput.value || "").trim();
            const rate  = toNumber(rateInput.value);
            const cost  = toNumber(costInput.value);

            if(!date || isNaN(start) || isNaN(end) || isNaN(odo)){
                alert("Date, Start%, End%, ODO are required.");
                return;
            }

            r.date = date;
            r.start = start;
            r.end = end;
            r.odo = odo;
            r.location = loc;
            r.rate = rate;
            r.cost = cost;

            recomputeDriveStats();
            saveRecords();
            renderRecords();
            renderSummary();

            if(loc && !locations.includes(loc)){
                locations.push(loc);
                saveLocations();
                renderLocations();
            }

            formCard.style.display="none";
            recordForm.removeEventListener("submit", handler);
            recordForm.addEventListener("submit", onSubmitForm, {once:false});
        };

        recordForm.removeEventListener("submit", onSubmitForm);
        recordForm.addEventListener("submit", handler);
    }

    function deleteRecord(id){
        if(!confirm("Delete this record?")) return;
        records = records.filter(r=>r.id!==id);
        recomputeDriveStats();
        saveRecords();
        renderRecords();
        renderSummary();
    }

    function renderSummary(){
        summaryBody.innerHTML="";
        if(records.length===0){
            summaryMonthLabel.textContent = "No drive data yet";
            return;
        }
        const today = new Date();
        const curY = today.getFullYear();
        const curM = today.getMonth()+1;

        let totalKm = 0;
        let totalKwh = 0;
        let totalCost = 0;

        for(const r of records){
            if(!r.date) continue;
            const [y,m] = r.date.split("-");
            const yy = Number(y), mm = Number(m);
            if(yy!==curY || mm!==curM) continue;
            if(r.driveKm!=null && r.usedKwh!=null){
                totalKm  += r.driveKm;
                totalKwh += r.usedKwh;
            }
            if(r.cost){
                totalCost += r.cost;
            }
        }

        const monthName = today.toLocaleString("en-US",{month:"short"});
        summaryMonthLabel.textContent = `${monthName} ${curY}`;

        if(totalKm<=0 || totalKwh<=0){
            const p = document.createElement("div");
            p.className="summary-empty";
            p.textContent="No drive data yet for this month.";
            summaryBody.appendChild(p);
            return;
        }

        const avgWhPerKm = totalKwh*1000/totalKm;

        const grid = document.createElement("div");
        grid.className="summary-grid";
        grid.innerHTML = `
            <div>
                <div class="summary-label">Total Cost (RM)</div>
                <div class="summary-value">${totalCost.toFixed(2)}</div>
            </div>
            <div>
                <div class="summary-label">Total Used (kWh)</div>
                <div class="summary-value">${totalKwh.toFixed(2)}</div>
            </div>
            <div>
                <div class="summary-label">Total KM</div>
                <div class="summary-value">${totalKm.toFixed(1)}</div>
            </div>
            <div>
                <div class="summary-label">Avg Wh/km</div>
                <div class="summary-value">${avgWhPerKm.toFixed(1)}</div>
            </div>
        `;
        summaryBody.appendChild(grid);
    }

    /* Locations */
    function renderLocations(){
        locationsList.innerHTML="";
        locationsDatalist.innerHTML="";

        for(const loc of locations){
            const row = document.createElement("div");
            row.className="location-row";

            const nameSpan = document.createElement("span");
            nameSpan.textContent = loc;

            const actions = document.createElement("div");
            actions.className="location-actions";

            const editBtn = document.createElement("button");
            editBtn.className="icon-btn";
            editBtn.textContent="‚úèÔ∏è";
            editBtn.addEventListener("click",()=>editLocation(loc));

            const delBtn = document.createElement("button");
            delBtn.className="icon-btn";
            delBtn.textContent="üóëÔ∏è";
            delBtn.addEventListener("click",()=>deleteLocation(loc));

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            row.appendChild(nameSpan);
            row.appendChild(actions);

            locationsList.appendChild(row);

            const opt = document.createElement("option");
            opt.value = loc;
            locationsDatalist.appendChild(opt);
        }
    }

    function onAddLocation(){
        const val = (newLocationInput.value || "").trim();
        if(!val) return;
        if(!locations.includes(val)){
            locations.push(val);
            saveLocations();
            renderLocations();
        }
        newLocationInput.value="";
    }

    function editLocation(oldName){
        const updated = prompt("Edit location:", oldName);
        if(!updated) return;
        const trimmed = updated.trim();
        if(!trimmed) return;
        const idx = locations.indexOf(oldName);
        if(idx>-1){
            locations[idx] = trimmed;
            saveLocations();
            renderLocations();
        }
    }

    function deleteLocation(name){
        if(!confirm("Delete this location?")) return;
        locations = locations.filter(l=>l!==name);
        saveLocations();
        renderLocations();
    }

    /* CSV Import / Export */
    function onExport(){
        if(records.length===0){
            alert("No data to export.");
            return;
        }
        let csv = "date,start,end,odo,location,rate,cost,driveKm,usedKwh,whPerKm\n";
        for(const r of records){
            const line = [
                r.date || "",
                safeNumber(r.start),
                safeNumber(r.end),
                safeNumber(r.odo),
                (r.location||"").replace(/,/g," "),
                safeNumber(r.rate,2),
                safeNumber(r.cost,2),
                r.driveKm!=null ? r.driveKm.toFixed(1) : "",
                r.usedKwh!=null ? r.usedKwh.toFixed(2) : "",
                r.whPerKm!=null ? r.whPerKm.toFixed(1) : ""
            ].join(",");
            csv += line + "\n";
        }
        const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,"0");
        const d = String(now.getDate()).padStart(2,"0");
        a.href=url;
        a.download=`ev-charge-log-v4-odo-${y}${m}${d}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function safeNumber(val,decimals){
        if(val===undefined || val===null || val==="") return "";
        if(typeof val!=="number") val = Number(val);
        if(isNaN(val)) return "";
        if(decimals!=null) return val.toFixed(decimals);
        return String(val);
    }

    function onImportFile(e){
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(evt){
            const text = evt.target.result;
            if(!text){ alert("Empty file."); return; }

            const replace = confirm("OK = Replace existing data\nCancel = Append to existing data");
            let newRecords = replace ? [] : records.slice();

            const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
            if(lines.length<=1){
                alert("No data rows found.");
                return;
            }
            const header = lines[0].toLowerCase();
            const hasHeader = header.includes("date") && header.includes("start");
            const startIndex = hasHeader ? 1 : 0;

            for(let i=startIndex;i<lines.length;i++){
                const row = lines[i].split(",");
                if(row.length<7) continue;
                const [date,start,end,odo,location,rate,cost] = row;
                const rec = {
                    id: "imp_"+i+"_"+Date.now(),
                    date: date.trim(),
                    start: toNumber(start.trim()),
                    end: toNumber(end.trim()),
                    odo: toNumber(odo.trim()),
                    location: (location||"").trim(),
                    rate: toNumber((rate||"").trim()),
                    cost: toNumber((cost||"").trim()),
                    driveKm:null,
                    usedKwh:null,
                    whPerKm:null
                };
                if(rec.date){
                    newRecords.push(rec);
                }
            }

            records = newRecords;
            recomputeDriveStats();
            saveRecords();
            renderRecords();
            renderSummary();
            importFile.value="";
            alert("Import complete.");
        };
        reader.readAsText(file);
    }

    document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
