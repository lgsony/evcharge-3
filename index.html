<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EV Charge Log Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{--bg:#000;--card:#1c1c1e;--text:#fff;--text2:#aaa;--red:#ff453a;--blue:#0a84ff;--green:#30d158;--gray:#333;}
  body{margin:0;font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);padding:env(safe-area-inset-top) env(safe-area-inset-right) 120px env(safe-area-inset-left);}
  header{padding:20px;text-align:center;font-size:30px;font-weight:800;position:relative;}
  .lang-switch{position:absolute;right:20px;top:20px;font-size:14px;background:var(--gray);padding:6px 12px;border-radius:20px;}
  .c{max-width:600px;margin:0 auto;padding:0 15px;}
  .card{background:var(--card);border-radius:18px;padding:20px;margin-bottom:20px;}
  input,select{width:100%;padding:16px;margin:9px 0;background:#2c2c2e;border:none;border-radius:12px;color:white;font-size:17px;}
  .row{display:flex;gap:12px;}
  .btn{background:var(--red);color:white;border:none;padding:17px;border-radius:14px;font-size:19px;font-weight:bold;width:100%;margin-top:12px;}
  .btn-green{background:var(--green);}
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:20px 0;}
  .stat{background:var(--card);padding:16px;border-radius:14px;text-align:center;}
  .stat-label{font-size:13px;color:var(--text2);margin-bottom:4px;}
  .stat-value{font-size:24px;font-weight:800;}
  .summary{display:flex;gap:15px;margin:20px 0;}
  .summary>div{flex:1;padding:18px;border-radius:14px;text-align:center;}
  .total-cost{background:#2c2c2e;}
  .total-kwh{background:var(--blue);color:white;}
  .big{font-size:28px;font-weight:800;}
  .quick-btns{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0;}
  .qb{padding:10px 16px;background:var(--gray);border-radius:50px;font-size:15px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{padding:13px 8px;text-align:left;border-bottom:1px solid #333;font-size:15px;}
  th{color:var(--text2);}
  .monthly div{display:flex;justify-content:space-between;padding:13px 0;}
  .monthly div:not(:last-child){border-bottom:1px solid #333;}
  .github{text-align:center;color:var(--text2);font-size:13px;margin:30px 0;}
</style>
</head>
<body>

<div class="c">
  <header>
    EV Charge Log Pro
    <div class="lang-switch" onclick="toggleLang()">
      <span id="langText">中</span>
    </div>
  </header>

  <!-- 最常用4个指标（按马来西亚用户优先级排序） -->
  <div class="stats">
    <div class="stat">
      <div class="stat-label" id="l1">Avg Rate</div>
      <div class="stat-value" id="avgRate">-</div>
    </div>
    <div class="stat">
      <div class="stat-label" id="l2">This Month</div>
      <div class="stat-value" id="monthCost">-</div>
    </div>
    <div class="stat">
      <div class="stat-label" id="l3">Saved vs 1.80</div>
      <div class="stat-value" id="saved">-</div>
    </div>
    <div class="stat">
      <div class="stat-label" id="l4">Total Sessions</div>
      <div class="stat-value" id="totalTimes">0</div>
    </div>
  </div>

  <!-- 总览大卡 -->
  <div class="summary">
    <div class="total-cost"><div id="l5">Total Cost</div><div class="big" id="totalCost">RM0.00</div></div>
    <div class="total-kwh"><div id="l6">Total Charged</div><div class="big" id="totalKwh">0.00 kWh</div></div>
  </div>

  <!-- 添加记录卡 -->
  <div class="card">
    <input type="date" id="date">
    <div class="row">
      <input type="number" inputmode="decimal" id="start" placeholder="Start %">
      <input type="number" inputmode="decimal" id="end" placeholder="End %">
    </div>

    <select id="location" onchange="autoFillRate()">
      <option value="">Select Location</option>
      <option value="BH">BH</option>
      <option value="PV">PV</option>
      <option value="BAMBOO HILL">BAMBOO HILL</option>
      <option value="HOME">HOME</option>
      <option value="WORK">WORK</option>
    </select>
    <input type="text" id="locationCustom" placeholder="Custom (auto uppercase)" oninput="this.value=this.value.toUpperCase();autoFillRate()">

    <div class="quick-btns">
      <button class="qb" onclick="setRate(0.84)">0.84</button>
      <button class="qb" onclick="setRate(1.00)">1.00</button>
      <button class="qb" onclick="setRate(1.30)">1.30</button>
      <button class="qb" onclick="setRate(1.50)">1.50</button>
      <button class="qb" onclick="setRate(1.80)">1.80</button>
      <button class="qb" onclick="setRate(0)">Free</button>
    </div>

    <div class="row">
      <input type="number" step="0.001" inputmode="decimal" id="rate" placeholder="Rate (RM/kWh)">
      <input type="number" step="0.01" inputmode="decimal" id="cost" placeholder="Cost (RM)">
    </div>

    <button class="btn btn-green" onclick="addRecord()">Add Record</button>
  </div>

  <!-- 月度统计 -->
  <div class="card monthly">
    <h3 id="l7">Monthly Total (RM)</h3>
    <div id="monthlyList"></div>
  </div>

  <!-- 记录列表 + 备份 -->
  <div class="card">
    <table id="logTable">
      <thead><tr><th>Date</th><th>Start</th><th>End</th><th>kWh</th><th>Location</th><th>Rate</th><th>Cost</th><th></th></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="card">
    <button class="btn" onclick="exportCSV()">Export CSV</button>
    <button class="btn" style="background:#333;margin-top:10px;" onclick="document.getElementById('importFile').click()">Import CSV</button>
    <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importCSV(this)">
    <div class="github">支持中英文一键切换 · 默认英文<br>数据永久保存在手机本地</div>
  </div>
</div>

<script>
// ================== 配置区 ==================
const BATTERY_CAPACITY = 60;      // 改成你车的电池容量
const BENCHMARK_RATE = 1.80;      // 用来算“省钱”的基准价

const KEY = 'evChargeLog2025';
const RATE_KEY = 'evLocationRateMemory';
const LANG_KEY = 'evLogLang';     // 新增：记住语言偏好

let records = JSON.parse(localStorage.getItem(KEY)||'[]');
let rateMemory = JSON.parse(localStorage.getItem(RATE_KEY)||'{}');
let isCN = localStorage.getItem(LANG_KEY) === 'cn';

const CN = {
  "l1":"平均电价","l2":"本月花费","l3":"比1.80省了","l4":"充电次数",
  "l5":"总花费","l6":"总电量","l7":"月度统计 (RM)",
  "lang":"EN"
};
const EN = {
  "l1":"Avg Rate","l2":"This Month","l3":"Saved vs 1.80","l4":"Total Sessions",
  "l5":"Total Cost","l6":"Total Charged","l7":"Monthly Total (RM)",
  "lang":"中"
};

function toggleLang(){
  isCN = !isCN;
  localStorage.setItem(LANG_KEY, isCN?'cn':'en');
  applyLang();
}
function applyLang(){
  const dict = isCN ? CN : EN;
  Object.keys(dict).forEach(id=>{
    if(id==='lang') document.getElementById('langText').textContent = dict[id];
    else if(document.getElementById(id)) document.getElementById(id).textContent = dict[id];
  });
  document.getElementById('saved').textContent = document.getElementById('saved').textContent.replace('vs 1.80', isCN?'比1.80省了':'vs 1.80');
}

// 其余功能和之前完全一样（自动记忆、计算等）——代码略，只保留核心更新部分
function setRate(v){document.getElementById('rate').value=v;}
function autoFillRate(){
  let loc = document.getElementById('location').value || document.getElementById('locationCustom').value.trim().toUpperCase();
  if(loc && rateMemory[loc]) document.getElementById('rate').value = rateMemory[loc];
}

function addRecord(){
  const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const start = parseInt(document.getElementById('start').value||0);
  const end = parseInt(document.getElementById('end').value||0);
  let location = document.getElementById('location').value || document.getElementById('locationCustom').value.trim().toUpperCase() || 'UNKNOWN';
  const rate = document.getElementById('rate').value ? parseFloat(document.getElementById('rate').value) : null;
  const costInput = document.getElementById('cost').value ? parseFloat(document.getElementById('cost').value) : null;

  if(isNaN(start)||isNaN(end)) return alert(isCN?'请填写起止电量':'Please fill Start & End %');

  const kwh = ((end-start)/100*BATTERY_CAPACITY).toFixed(2);
  const cost = costInput !== null ? costInput : (rate ? (kwh*rate) : null);

  if(rate!==null){rateMemory[location]=rate; localStorage.setItem(RATE_KEY,JSON.stringify(rateMemory));}

  records.push({date,start,end,kwh:parseFloat(kwh),location,rate,cost:cost!==null?parseFloat(cost.toFixed(2)):null,id:Date.now()});
  localStorage.setItem(KEY,JSON.stringify(records));

  document.getElementById('start').value='';
  document.getElementById('end').value='';
  document.getElementById('cost').value='';
  document.getElementById('end').focus();
  load();
}

// 统计更新（同之前）
function updateAllStats(){
  const paid = records.filter(r=>r.cost!==null);
  const totalCost = paid.reduce((s,r)=>s+r.cost,0).toFixed(2);
  const totalKwh = records.reduce((s,r)=>s+r.kwh,0).toFixed(2);
  const avg = totalKwh>0 ? (totalCost/totalKwh).toFixed(3) : 0;
  const saved = (totalKwh * BENCHMARK_RATE - totalCost).toFixed(2);

  const thisMonth = new Date().toISOString().slice(0,7);
  const monthCost = records.filter(r=>r.date.startsWith(thisMonth)&&r.cost).reduce((s,r)=>s+r.cost,0).toFixed(2);

  document.getElementById('avgRate').textContent = avg ? `${avg}/kWh` : '-';
  document.getElementById('monthCost').textContent = `RM${monthCost}`;
  document.getElementById('saved').textContent = `RM${saved}`;
  document.getElementById('totalTimes').textContent = records.length;
  document.getElementById('totalCost').textContent = `RM${totalCost}`;
  document.getElementById('totalKwh').textContent = `${totalKwh} kWh`;

  // 月度列表省略...
}

function load(){records.sort((a,b)=>new Date(b.date)-new Date(a.date));renderTable();updateAllStats();}
function renderTable(){/* 同之前 */}

// 初始化
document.getElementById('date').value = new Date().toISOString().slice(0,10);
applyLang();   // 关键：先恢复语言
load();
</script>

<!-- exportCSV / importCSV 代码保持不变，略（和上个版本完全一样） -->
</body>
</html>
