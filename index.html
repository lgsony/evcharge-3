<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EV Charge Log Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  :root{--bg:#000;--card:#1c1c1e;--text:#fff;--text2:#aaa;--red:#ff453a;--green:#30d158;--blue:#0a84ff;--gray:#333;}
  body{margin:0;font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);padding-bottom:120px;}
  header{padding:20px;text-align:center;font-size:30px;font-weight:800;}
  .c{max-width:600px;margin:0 auto;padding:0 15px;}
  .card{background:var(--card);border-radius:18px;padding:20px;margin-bottom:20px;}
  input,select{width:100%;padding:16px;margin:9px 0;background:#2c2c2e;border:none;border-radius:12px;color:white;font-size:17px;}
  .row{display:flex;gap:12px;}
  .btn{background:var(--green);color:white;border:none;padding:17px;border-radius:14px;font-size:19px;font-weight:bold;width:100%;margin-top:12px;}
  .btn-red{background:var(--red);}
  .quick-btns{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0;}
  .qb{padding:10px 16px;background:var(--gray);border-radius:50px;font-size:15px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{padding:13px 8px;border-bottom:1px solid #333;font-size:15px;}
  th{color:var(--text2);}
  .github{text-align:center;color:var(--text2);font-size:13px;margin:30px 0;}
</style>
</head>
<body>

<div class="c">
  <header>EV Charge Log Pro</header>

  <div class="card">
    <input type="date" id="date">
    <div class="row">
      <input type="number" inputmode="decimal" id="start" placeholder="Start %">
      <input type="number" inputmode="decimal" id="end" placeholder="End %">
    </div>

    <select id="location" onchange="handleLocationChange()">
      <option value="">Select Location</option>
      <option value="__ADD__">+ Add New Location</option>
      <option disabled>────────────────</option>
    </select>

    <div class="quick-btns">
      <button class="qb" onclick="setRate(0.84)">0.84</button>
      <button class="qb" onclick="setRate(1.00)">1.00</button>
      <button class="qb" onclick="setRate(1.30)">1.30</button>
      <button class="qb" onclick="setRate(1.50)">1.50</button>
      <button class="qb" onclick="setRate(1.80)">1.80</button>
      <button class="qb" onclick="setRate(0)">Free</button>
    </div>

    <div class="row">
      <input type="number" step="0.001" inputmode="decimal" id="rate" placeholder="Rate (RM/kWh)">
      <input type="number" step="0.01" inputmode="decimal" id="cost" placeholder="Cost (RM) 可不填">
    </div>

    <button class="btn" onclick="addRecord()">Add Record</button>
  </div>

  <!-- 统计卡片略（可加回来） -->

  <div class="card">
    <table id="logTable">
      <thead><tr><th>Date</th><th>Start</th><th>End</th><th>kWh</th><th>Location</th><th>Rate</th><th>Cost</th></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="card">
    <button class="btn" onclick="exportAll()">Export All Data (CSV)</button>
    <button class="btn btn-red" onclick="document.getElementById('importFile').click()">
      Import All Data (CSV)
    </button>
    <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importAll(this)">
    <div class="github">
      完全支持导出导入：<br>
      • 所有充电记录<br>
      • 所有自定义地点<br>
      • 每个地点的价格记忆<br>
      换手机一键恢复！
    </div>
  </div>
</div>

<script>
const BATTERY_CAPACITY = 60;

const KEY_RECORDS = 'evRecords2025';
const KEY_LOCATIONS = 'evLocations2025';
const KEY_RATES = 'evRateMemory2025';

let records = JSON.parse(localStorage.getItem(KEY_RECORDS)||'[]');
let customLocations = JSON.parse(localStorage.getItem(KEY_LOCATIONS)||'[]');
let rateMemory = JSON.parse(localStorage.getItem(KEY_RATES)||'{}');

const defaultLocations = ["BH","PV","BAMBOO HILL","HOME","WORK"];

function allLocations() {
  return [...new Set([...defaultLocations, ...customLocations])].sort();
}

function renderLocations() {
  const select = document.getElementById('location');
  select.innerHTML = `<option value="">Select Location</option><option value="__ADD__">+ Add New Location</option><option disabled>────────────────</option>`;
  allLocations().forEach(loc => {
    const opt = document.createElement('option');
    opt.value = loc; opt.textContent = loc;
    select.appendChild(opt);
  });
}

function handleLocationChange() {
  const val = document.getElementById('location').value;
  if (val === "__ADD__") {
    const name = prompt("输入新地点（自动大写）")?.trim().toUpperCase();
    if (name && !allLocations().includes(name)) {
      customLocations.push(name);
      localStorage.setItem(KEY_LOCATIONS, JSON.stringify(customLocations));
      renderLocations();
      document.getElementById('location').value = name;
      autoFillRate();
    } else {
      document.getElementById('location').value = "";
    }
  } else {
    autoFillRate();
  }
}

function autoFillRate() {
  const loc = document.getElementById('location').value;
  if (loc && rateMemory[loc]) {
    document.getElementById('rate').value = rateMemory[loc];
  }
}

function setRate(v) { document.getElementById('rate').value = v; }

function addRecord() {
  let loc = document.getElementById('location').value;
  if (!loc) { alert("请选择或输入地点"); return; }

  const start = parseInt(document.getElementById('start').value||0);
  const end = parseInt(document.getElementById('end').value||0);
  if (isNaN(start) || isNaN(end)) { alert("请填写起止电量"); return; }

  const rate = document.getElementById('rate').value ? parseFloat(document.getElementById('rate').value) : null;
  const manualCost = document.getElementById('cost').value ? parseFloat(document.getElementById('cost').value) : null;

  const kwh = ((end - start) / 100 * BATTERY_CAPACITY).toFixed(2);
  const cost = manualCost !== null ? manualCost : (rate ? (kwh * rate).toFixed(2) : null);

  if (rate !== null) {
    rateMemory[loc] = rate;
    localStorage.setItem(KEY_RATES, JSON.stringify(rateMemory));
  }

  records.push({
    date: document.getElementById('date').value || new Date().toISOString().slice(0,10),
    start, end, kwh: parseFloat(kwh), location: loc,
    rate, cost: cost ? parseFloat(cost) : null,
    id: Date.now()
  });

  localStorage.setItem(KEY_RECORDS, JSON.stringify(records));
  document.getElementById('start').value = document.getElementById('end').value = document.getElementById('cost').value = '';
  document.getElementById('end').focus();
  renderTable();
}

// 导出全部数据（记录 + 地点 + 价格记忆）
function exportAll() {
  let csv = '\uFEFF# EV Charge Log Backup - 包含地点和价格记忆\n';
  csv += `# Locations: ${allLocations().join('|')}\n`;
  csv += `# RateMemory: ${JSON.stringify(rateMemory)}\n\n`;
  csv += 'Date,Start%,End%,kWh,Location,Rate,Cost\n';
  records.forEach(r => {
    csv += `${r.date},${r.start},${r.end},${r.kwh},${r.location},${r.rate||''},${r.cost||''}\n`;
  });

  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `EV_Log_Full_Backup_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// 导入全部数据
function importAll(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const lines = text.split('\n');
    
    // 解析自定义地点和价格记忆
    lines.forEach(line => {
      if (line.startsWith('# Locations:')) {
        const locs = line.split(':')[1].trim().split('|').filter(Boolean);
        customLocations = locs.filter(l => !defaultLocations.includes(l));
        localStorage.setItem(KEY_LOCATIONS, JSON.stringify(customLocations));
      }
      if (line.startsWith('# RateMemory:')) {
        try {
          rateMemory = JSON.parse(line.split(':')[1].trim());
          localStorage.setItem(KEY_RATES, JSON.stringify(rateMemory));
        } catch(e) {}
      }
    });

    // 解析记录
    const dataStart = lines.findIndex(l => l.includes('Date,Start%,End%'));
    if (dataStart !== -1) {
      records = [];
      lines.slice(dataStart + 1).forEach(line => {
        if (!line.trim() || line.startsWith('#')) return;
        const [date,s,e,kwh,loc,rate,cost] = line.split(',');
        if (date) {
          records.push({
            date: date.trim(),
            start: parseInt(s), end: parseInt(e), kwh: parseFloat(kwh||0),
            location: loc.trim(),
            rate: rate ? parseFloat(rate) : null,
            cost: cost ? parseFloat(cost) : null,
            id: Date.now() + Math.random()
          });
        }
      });
      localStorage.setItem(KEY_RECORDS, JSON.stringify(records));
    }

    renderLocations();
    renderTable();
    alert('全部数据已恢复！包括自定义地点和价格记忆');
  };
  reader.readAsText(file);
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  records.slice().reverse().forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date.split('-').reverse().join('/')}</td><td>${r.start}</td><td>${r.end}</td><td>${r.kwh}</td><td>${r.location}</td><td>${r.rate||'-'}</td><td>${r.cost!=null?'RM'+r.cost.toFixed(2):'-'}</td>`;
    tbody.appendChild(tr);
  });
}

// 初始化
document.getElementById('date').value = new Date().toISOString().slice(0,10);
renderLocations();
renderTable();
</script>
</body>
</html>
