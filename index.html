<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <title>EV Charge Log Pro v5 ‚Äì Â∞èÂ∏Ö‰∏ìÁî®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-top: #120104;
      --bg-bottom: #000000;
      --card: #191919;
      --card-soft: #222222;
      --border: #303030;
      --border-soft: #2a2a2a;
      --text: #ffffff;
      --text-soft: #b8b8b8;
      --accent: #ff3b3b;
      --accent-soft: #ff4f4f;
      --danger: #ff4b5c;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.7);
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        system-ui, -segoe-ui, Roboto, sans-serif;
      background: radial-gradient(circle at top, var(--bg-top) 0, #050002 22%, var(--bg-bottom) 60%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 14px 88px;
    }

    header {
      text-align: center;
      margin-bottom: 10px;
    }

    header h1 {
      margin: 6px 0 4px;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--accent-soft);
      text-transform: uppercase;
    }

    header .sub {
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card {
      background: radial-gradient(circle at top left, #222, #151515);
      border-radius: 22px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px;
      margin-bottom: 10px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-soft);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .field {
      margin-bottom: 8px;
    }

    .field label {
      display: block;
      font-size: 11px;
      margin-bottom: 4px;
      color: var(--text-soft);
    }

    .field .right-label {
      float: right;
      font-size: 10px;
      opacity: 0.6;
    }

    .input-shell {
      position: relative;
    }

    input,
    select {
      width: 100%;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: #141414;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border 0.15s ease, background 0.15s ease,
        box-shadow 0.15s ease;
    }

    input:focus,
    select:focus {
      border-color: var(--accent-soft);
      background: #181818;
      box-shadow: 0 0 0 1px rgba(255, 59, 59, 0.3);
    }

    input::placeholder {
      color: #555;
    }

    .inline-two {
      display: flex;
      gap: 8px;
    }

    .inline-two .field {
      flex: 1;
      margin-bottom: 0;
    }

    .date-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .date-row input[type="date"] {
      flex: 1;
      font-size: 13px;
    }

    .date-icon {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--text-soft);
    }

    /* Rate quick buttons */
    .rate-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      margin-top: 4px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 5px 10px;
      font-size: 12px;
      color: var(--text-soft);
      background: #181818;
      cursor: pointer;
      min-width: 52px;
      text-align: center;
      transition: background 0.15s ease, border 0.15s ease,
        color 0.15s ease, transform 0.06s ease;
    }

    .chip:active {
      transform: scale(0.96);
    }

    .chip.selected {
      background: var(--accent);
      color: #000;
      border-color: var(--accent-soft);
    }

    .help-text {
      font-size: 10px;
      color: #ff9ea7;
      margin-top: 3px;
    }

    /* Buttons */
    .btn {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      background: #181818;
      color: var(--text-soft);
      font-size: 13px;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
      transition: background 0.15s ease, transform 0.06s ease,
        border 0.15s ease, color 0.15s ease;
      white-space: nowrap;
    }

    .btn span.icon {
      font-size: 16px;
    }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--accent-soft), #e22626);
      border-color: rgba(255, 59, 59, 0.9);
      color: #fff;
      font-weight: 600;
      padding-top: 10px;
      padding-bottom: 10px;
      font-size: 15px;
      margin-top: 6px;
    }

    .btn-primary:active {
      transform: scale(0.98);
      background: linear-gradient(135deg, #ff5d5d, #d92020);
    }

    .btn-soft {
      background: #141414;
      font-size: 12px;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 11px;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
    }

    /* Records table */
    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #1c1c1c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 650px;
    }

    thead {
      background: #141414;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 6px 6px;
      text-align: right;
      border-bottom: 1px solid #1a1a1a;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    th {
      font-weight: 500;
      color: var(--text-soft);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr:nth-child(2n) {
      background: rgba(255, 255, 255, 0.02);
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    td .badge-loc {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 10px;
      color: var(--text-soft);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    td .action-row {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
    }

    td .action-row button {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #101010;
      color: var(--text-soft);
      cursor: pointer;
      transition: background 0.12s ease, transform 0.06s ease;
    }

    td .action-row button:active {
      transform: scale(0.96);
      background: #191919;
    }

    td .action-row .delete {
      border-color: rgba(255, 75, 92, 0.45);
      color: #ff9aa4;
    }

    .empty-state {
      text-align: center;
      padding: 10px 4px;
      font-size: 12px;
      color: var(--text-soft);
    }

    /* Monthly summary */
    .summary-body {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-top: 4px;
    }

    .summary-card {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      background: #141414;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .summary-month {
      font-size: 11px;
      font-weight: 500;
    }

    .summary-kpi {
      font-size: 10px;
      color: var(--text-soft);
    }

    .summary-kpi strong {
      color: var(--accent-soft);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 2px;
      color: var(--text-soft);
    }

    .summary-row span.value {
      color: #f5f5f5;
    }

    /* Saved locations list */
    .loc-list-empty {
      font-size: 12px;
      color: var(--text-soft);
      padding: 4px 0 2px;
    }

    .loc-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #222;
    }

    .loc-row:last-child {
      border-bottom: none;
    }

    .loc-name {
      font-size: 13px;
    }

    .loc-actions {
      display: flex;
      gap: 6px;
    }

    .icon-btn {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #141414;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      padding: 0;
    }

    .icon-btn:active {
      transform: scale(0.95);
      background: #1d1d1d;
    }

    .icon-btn.danger {
      border-color: rgba(255, 75, 92, 0.5);
      color: #ff9aa4;
    }

    .chip-count {
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Bottom bar */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.94);
      border-top: 1px solid var(--border);
      padding: 8px 14px 10px;
      display: flex;
      justify-content: center;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .bottom-inner {
      max-width: 480px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .bottom-group {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .bottom-hint {
      font-size: 9px;
      color: var(--text-soft);
      text-align: right;
    }

    input[type="file"] {
      display: none;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: #171717;
      color: var(--text-soft);
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 20;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(4px);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: #111;
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 12px;
      width: 100%;
      max-width: 360px;
      box-shadow: var(--shadow-soft);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .modal-body {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .radio-row {
      display: flex;
      gap: 10px;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .radio-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    @media (min-width: 520px) {
      header h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <!-- Import Mode Modal -->
  <div class="modal-backdrop" id="importModal">
    <div class="modal">
      <div class="modal-title">Import CSV</div>
      <div class="modal-body">ÈÄâÊã©ÂØºÂÖ•ÊñπÂºèÔºö</div>
      <div class="radio-row">
        <label>
          <input type="radio" name="importMode" value="append" checked />
          ËøΩÂä† (Append)
        </label>
        <label>
          <input type="radio" name="importMode" value="replace" />
          Ë¶ÜÁõñ (Replace)
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn btn-sm btn-soft" id="importCancelBtn">ÂèñÊ∂à</button>
        <button class="btn btn-sm btn-primary" id="importConfirmBtn">ÈÄâÊã©Êñá‰ª∂</button>
      </div>
      <input type="file" id="fileInput" accept=".csv,text/csv" />
    </div>
  </div>

  <div class="app">
    <header>
      <div class="sub">TESLA ¬∑ 60 kWh PACK</div>
      <h1>EV Charge Log Pro</h1>
    </header>

    <!-- Main form card -->
    <section class="card">
      <div class="field">
        <label>Date</label>
        <div class="date-row">
          <input id="dateInput" type="date" />
          <div class="date-icon">üìÖ</div>
        </div>
      </div>

      <div class="inline-two" style="margin-bottom:8px;">
        <div class="field">
          <label>
            Start %
            <span class="right-label">2‰ΩçËá™Âä®Ë∑≥</span>
          </label>
          <input
            id="startPercent"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="2"
            placeholder="Start %"
          />
        </div>
        <div class="field">
          <label>
            End %
            <span class="right-label">2‰ΩçËá™Âä®Ë∑≥</span>
          </label>
          <input
            id="endPercent"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="2"
            placeholder="End %"
          />
        </div>
      </div>

      <div class="field">
        <label>ODO (km)</label>
        <input
          id="odoInput"
          type="text"
          inputmode="numeric"
          pattern="[0-9]*"
          placeholder="‰æãÂ¶Ç 12850"
        />
      </div>

      <div class="field">
        <label>
          Select Location
          <span class="right-label chip-count" id="locationCount">0 saved</span>
        </label>
        <select id="locationSelect">
          <option value="">ËØ∑ÈÄâÊã©Âú∞ÁÇπ</option>
        </select>
      </div>

      <div class="field">
        <label>Add / Edit Location</label>
        <input
          id="locationCustom"
          type="text"
          placeholder="‰æãÂ¶Ç HOME, PAVILION-KL, BAMBOO HILL..."
        />
        <div style="display:flex; gap:6px; margin-top:6px;">
          <button class="btn btn-soft btn-sm" id="saveLocationBtn">
            <span class="icon">Ôºã</span> ‰øùÂ≠òÂú∞ÁÇπ
          </button>
        </div>
      </div>

      <div class="field">
        <label>Rate (RM/kWh)</label>
        <div class="rate-chips">
          <div class="chip" data-rate="0.84">0.84</div>
          <div class="chip" data-rate="1.00">1.00</div>
          <div class="chip" data-rate="1.30">1.30</div>
          <div class="chip" data-rate="1.50">1.50</div>
          <div class="chip" data-rate="1.80">1.80</div>
          <div class="chip" data-rate="0">Free</div>
        </div>
      </div>

      <div class="inline-two">
        <div class="field">
          <label>Rate (RM/kWh)</label>
          <input
            id="rateInput"
            type="text"
            inputmode="decimal"
            placeholder="‰æãÂ¶Ç 1.50"
          />
        </div>
        <div class="field">
          <label>Cost (RM)</label>
          <input
            id="costInput"
            type="text"
            inputmode="decimal"
            placeholder="‰æãÂ¶Ç 18.90"
          />
        </div>
      </div>

      <button class="btn btn-primary" id="addRecordBtn">
        Add Record
      </button>

      <div class="summary-body" id="prevInfo" style="margin-top:6px;">
        ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï„ÄÇÁ¨¨‰∏ÄÊù°ËÆ∞ÂΩïÂ∞Ü‰∏ç‰ºöËÆ°ÁÆó KM / kWh / Wh/km„ÄÇ
      </div>
    </section>

    <!-- Monthly summary -->
    <section class="card">
      <div class="card-header-row">
        <div class="card-title">Monthly Summary (60 kWh pack)</div>
      </div>
      <div id="summaryContainer">
        <div class="empty-state">No drive data yet</div>
      </div>
    </section>

    <!-- Records table -->
    <section class="card">
      <div class="card-header-row">
        <div class="card-title">Charge Log</div>
        <div class="card-subtitle">Date / Start / End / kWh / KM / Rate / Cost</div>
      </div>
      <div class="table-wrapper" id="tableWrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Start%</th>
              <th>End%</th>
              <th>Used kWh</th>
              <th>KM</th>
              <th>Wh/km</th>
              <th>Location</th>
              <th>Rate</th>
              <th>Cost</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
      <div class="empty-state" id="emptyState">
        ËøòÊ≤°ÊúâËÆ∞ÂΩï„ÄÇ‰∏äÈù¢Â°´ÂÜô‰∏ÄÊ¨°ÂÖÖÁîµÊï∞ÊçÆÔºåÁÑ∂ÂêéÁÇπ„ÄåAdd Record„Äç„ÄÇ
      </div>
    </section>

    <!-- Saved locations -->
    <section class="card">
      <div class="card-header-row">
        <div class="card-title">Saved Locations</div>
      </div>
      <div id="locationsList">
        <div class="loc-list-empty">ÊöÇÊó∂Ê≤°Êúâ‰øùÂ≠òÁöÑÂú∞ÁÇπ„ÄÇ</div>
      </div>
    </section>
  </div>

  <!-- Bottom bar -->
  <div class="bottom-bar">
    <div class="bottom-inner">
      <div class="bottom-group">
        <button class="btn btn-soft" id="exportBtn">
          <span class="icon">‚á£</span> Export
        </button>
        <button class="btn btn-soft" id="importBtn">
          <span class="icon">‚á°</span> Import
        </button>
      </div>
      <div class="bottom-hint">
        CSV Â≠óÊÆµÔºödate,start,end,odo,location,rate,cost,driveKm,usedKwh,whPerKm
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY_RECORDS = "evChargeLogPro_v5_records";
    const STORAGE_KEY_LOCATIONS = "evChargeLogPro_v5_locations";

    const dateInput = document.getElementById("dateInput");
    const startPercentInput = document.getElementById("startPercent");
    const endPercentInput = document.getElementById("endPercent");
    const odoInput = document.getElementById("odoInput");
    const locationSelect = document.getElementById("locationSelect");
    const locationCustom = document.getElementById("locationCustom");
    const locationCount = document.getElementById("locationCount");
    const rateInput = document.getElementById("rateInput");
    const costInput = document.getElementById("costInput");
    const addRecordBtn = document.getElementById("addRecordBtn");
    const saveLocationBtn = document.getElementById("saveLocationBtn");
    const prevInfo = document.getElementById("prevInfo");

    const recordsBody = document.getElementById("recordsBody");
    const emptyState = document.getElementById("emptyState");
    const summaryContainer = document.getElementById("summaryContainer");
    const locationsList = document.getElementById("locationsList");

    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const toastEl = document.getElementById("toast");
    const tableWrapper = document.getElementById("tableWrapper");

    const importModal = document.getElementById("importModal");
    const importCancelBtn = document.getElementById("importCancelBtn");
    const importConfirmBtn = document.getElementById("importConfirmBtn");
    const fileInput = document.getElementById("fileInput");

    const rateChips = document.querySelectorAll(".chip[data-rate]");

    let records = [];
    let locations = [];
    let editingId = null;
    let editingLocationIndex = null;

    function showToast(msg, duration = 2000) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, duration);
    }

    function loadState() {
      try {
        const recStr = localStorage.getItem(STORAGE_KEY_RECORDS);
        records = recStr ? JSON.parse(recStr) : [];
      } catch (e) {
        records = [];
      }
      try {
        const locStr = localStorage.getItem(STORAGE_KEY_LOCATIONS);
        locations = locStr ? JSON.parse(locStr) : [];
      } catch (e) {
        locations = [];
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
      localStorage.setItem(STORAGE_KEY_LOCATIONS, JSON.stringify(locations));
    }

    function formatNumber(num, decimals) {
      if (num === null || num === undefined || isNaN(num)) return "-";
      return Number(num).toFixed(decimals);
    }

    function defaultToday() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function updateLocationSelect() {
      locationSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Âú∞ÁÇπ</option>';
      locations.forEach((loc) => {
        const opt = document.createElement("option");
        opt.value = loc;
        opt.textContent = loc;
        locationSelect.appendChild(opt);
      });
      locationCount.textContent = `${locations.length} saved`;
      renderLocationsList();
    }

    function renderLocationsList() {
      locationsList.innerHTML = "";
      if (!locations.length) {
        const div = document.createElement("div");
        div.className = "loc-list-empty";
        div.textContent = "ÊöÇÊó∂Ê≤°Êúâ‰øùÂ≠òÁöÑÂú∞ÁÇπ„ÄÇ";
        locationsList.appendChild(div);
        return;
      }
      locations.forEach((loc, index) => {
        const row = document.createElement("div");
        row.className = "loc-row";

        const name = document.createElement("div");
        name.className = "loc-name";
        name.textContent = loc;
        row.appendChild(name);

        const actions = document.createElement("div");
        actions.className = "loc-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.addEventListener("click", () => {
          editingLocationIndex = index;
          locationCustom.value = loc;
          locationSelect.value = loc;
          showToast("Â∑≤ËΩΩÂÖ•Âú∞ÁÇπÔºåÂèØÁºñËæëÂêéÁÇπ‚Äú‰øùÂ≠òÂú∞ÁÇπ‚Äù");
        });

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.innerHTML = "üóë";
        delBtn.addEventListener("click", () => {
          if (!confirm(`Á°ÆÂÆöÂà†Èô§Âú∞ÁÇπ„Äå${loc}„ÄçÔºü`)) return;
          locations.splice(index, 1);
          if (editingLocationIndex === index) editingLocationIndex = null;
          updateLocationSelect();
          saveState();
          showToast("Âú∞ÁÇπÂ∑≤Âà†Èô§");
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        row.appendChild(actions);

        locationsList.appendChild(row);
      });
    }

    function getSelectedLocation() {
      if (locationCustom.value.trim()) {
        return locationCustom.value.trim();
      }
      return locationSelect.value || "";
    }

    function ensureLocationExists(loc) {
      if (!loc) return;
      if (!locations.includes(loc)) {
        locations.push(loc);
        locations.sort((a, b) => a.localeCompare(b));
        updateLocationSelect();
        saveState();
      }
    }

    function getSortedRecords() {
      return [...records].sort((a, b) => {
        if (a.date === b.date) {
          return (a.createdAt || 0) - (b.createdAt || 0);
        }
        return a.date.localeCompare(b.date);
      });
    }

    function recomputeDerived() {
      const sorted = getSortedRecords();
      for (let i = 0; i < sorted.length; i++) {
        const curr = sorted[i];
        if (i === 0) {
          curr.driveKm = null;
          curr.usedKwh = null;
          curr.whPerKm = null;
        } else {
          const prev = sorted[i - 1];
          const odoCurr = Number(curr.odo);
          const odoPrev = Number(prev.odo);
          const startCurr = Number(curr.start);
          const endPrev = Number(prev.end);

          let driveKm = odoCurr - odoPrev;
          if (!isFinite(driveKm) || isNaN(driveKm) || driveKm <= 0) {
            driveKm = null;
          }

          let usedKwh = (60 * (endPrev - startCurr)) / 100;
          if (!isFinite(usedKwh) || isNaN(usedKwh) || usedKwh <= 0) {
            usedKwh = null;
          }

          let whPerKm = null;
          if (driveKm && usedKwh) {
            whPerKm = (usedKwh * 1000) / driveKm;
          }

          curr.driveKm = driveKm;
          curr.usedKwh = usedKwh;
          curr.whPerKm = whPerKm;
        }
      }
      records = sorted;
    }

    function renderPrevInfo() {
      if (!records.length) {
        prevInfo.textContent =
          "ÊöÇÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï„ÄÇÁ¨¨‰∏ÄÊù°ËÆ∞ÂΩïÂ∞Ü‰∏ç‰ºöËÆ°ÁÆó KM / kWh / Wh/km„ÄÇ";
        return;
      }
      const last = getSortedRecords()[records.length - 1];
      prevInfo.innerHTML = `‰∏ä‰∏ÄÊù°ËÆ∞ÂΩïÔºö<strong>${last.date}</strong> ¬∑ End <strong>${last.end}%</strong> ¬∑ ODO <strong>${last.odo} km</strong>`;
    }

    function renderRecords() {
      recordsBody.innerHTML = "";
      const sorted = getSortedRecords();
      if (!sorted.length) {
        emptyState.style.display = "block";
        return;
      }
      emptyState.style.display = "none";

      sorted.forEach((rec) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = rec.date;

        const tdStart = document.createElement("td");
        tdStart.textContent = rec.start;

        const tdEnd = document.createElement("td");
        tdEnd.textContent = rec.end;

        const tdUsed = document.createElement("td");
        tdUsed.textContent = formatNumber(rec.usedKwh, 2);

        const tdKm = document.createElement("td");
        tdKm.textContent = rec.driveKm == null ? "-" : rec.driveKm;

        const tdWh = document.createElement("td");
        tdWh.textContent = formatNumber(rec.whPerKm, 0);

        const tdLoc = document.createElement("td");
        const locBadge = document.createElement("span");
        locBadge.className = "badge-loc";
        locBadge.textContent = rec.location || "‚Äî";
        tdLoc.appendChild(locBadge);

        const tdRate = document.createElement("td");
        tdRate.textContent =
          rec.rate === "" || rec.rate == null ? "-" : formatNumber(rec.rate, 2);

        const tdCost = document.createElement("td");
        tdCost.textContent =
          rec.cost === "" || rec.cost == null ? "-" : formatNumber(rec.cost, 2);

        const tdActions = document.createElement("td");
        const actionRow = document.createElement("div");
        actionRow.className = "action-row";

        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          loadRecordToForm(rec.id);
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "Del";
        delBtn.className = "delete";
        delBtn.addEventListener("click", () => {
          if (confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü")) {
            deleteRecord(rec.id);
          }
        });

        actionRow.appendChild(editBtn);
        actionRow.appendChild(delBtn);
        tdActions.appendChild(actionRow);

        tr.appendChild(tdDate);
        tr.appendChild(tdStart);
        tr.appendChild(tdEnd);
        tr.appendChild(tdUsed);
        tr.appendChild(tdKm);
        tr.appendChild(tdWh);
        tr.appendChild(tdLoc);
        tr.appendChild(tdRate);
        tr.appendChild(tdCost);
        tr.appendChild(tdActions);

        recordsBody.appendChild(tr);
      });
    }

    function renderSummary() {
      summaryContainer.innerHTML = "";
      const sorted = getSortedRecords();
      if (!sorted.length) {
        summaryContainer.innerHTML =
          '<div class="empty-state">No drive data yet</div>';
        return;
      }

      const byMonth = {};
      sorted.forEach((rec) => {
        if (!rec.date) return;
        const month = rec.date.slice(0, 7);
        if (!byMonth[month]) {
          byMonth[month] = {
            totalRM: 0,
            totalKwh: 0,
            totalKm: 0,
            whSum: 0,
            whCount: 0,
          };
        }
        const bucket = byMonth[month];
        const cost = Number(rec.cost);
        const kwh = Number(rec.usedKwh);
        const km = Number(rec.driveKm);
        const wh = Number(rec.whPerKm);

        if (!isNaN(cost)) bucket.totalRM += cost;
        if (!isNaN(kwh)) bucket.totalKwh += kwh;
        if (!isNaN(km)) bucket.totalKm += km;
        if (!isNaN(wh)) {
          bucket.whSum += wh;
          bucket.whCount += 1;
        }
      });

      const months = Object.keys(byMonth).sort();
      const grid = document.createElement("div");
      grid.className = "summary-grid";

      months.forEach((month) => {
        const data = byMonth[month];
        const avgWh =
          data.whCount > 0 ? data.whSum / data.whCount : null;

        const card = document.createElement("div");
        card.className = "summary-card";

        const header = document.createElement("div");
        header.className = "summary-header";

        const mLabel = document.createElement("div");
        mLabel.className = "summary-month";
        mLabel.textContent = month;

        const kpi = document.createElement("div");
        kpi.className = "summary-kpi";
        kpi.innerHTML = `Wh/km: <strong>${
          avgWh == null ? "-" : avgWh.toFixed(0)
        }</strong>`;

        header.appendChild(mLabel);
        header.appendChild(kpi);

        const row1 = document.createElement("div");
        row1.className = "summary-row";
        row1.innerHTML = `<span>ÊÄª RM</span><span class="value">${data.totalRM.toFixed(
          2
        )}</span>`;

        const row2 = document.createElement("div");
        row2.className = "summary-row";
        row2.innerHTML = `<span>ÊÄª used kWh</span><span class="value">${data.totalKwh.toFixed(
          2
        )}</span>`;

        const row3 = document.createElement("div");
        row3.className = "summary-row";
        row3.innerHTML = `<span>ÊÄª KM</span><span class="value">${data.totalKm.toFixed(
          0
        )}</span>`;

        card.appendChild(header);
        card.appendChild(row1);
        card.appendChild(row2);
        card.appendChild(row3);

        grid.appendChild(card);
      });

      summaryContainer.appendChild(grid);
    }

    function refreshAll() {
      recomputeDerived();
      saveState();
      renderRecords();
      renderSummary();
      renderPrevInfo();
    }

    function clearForm() {
      editingId = null;
      startPercentInput.value = "";
      endPercentInput.value = "";
      odoInput.value = "";
      locationCustom.value = "";
      locationSelect.value = "";
      rateInput.value = "";
      costInput.value = "";
      addRecordBtn.textContent = "Add Record";
      rateChips.forEach((c) => c.classList.remove("selected"));
    }

    function loadRecordToForm(id) {
      const rec = records.find((r) => r.id === id);
      if (!rec) return;
      editingId = id;
      dateInput.value = rec.date;
      startPercentInput.value = rec.start;
      endPercentInput.value = rec.end;
      odoInput.value = rec.odo;
      rateInput.value = rec.rate ?? "";
      costInput.value = rec.cost ?? "";
      locationCustom.value = rec.location || "";

      if (rec.location && locations.includes(rec.location)) {
        locationSelect.value = rec.location;
      } else {
        locationSelect.value = "";
      }

      rateChips.forEach((chip) => {
        const r = chip.getAttribute("data-rate");
        if (rec.rate != null && Number(r) === Number(rec.rate)) {
          chip.classList.add("selected");
        } else {
          chip.classList.remove("selected");
        }
      });

      addRecordBtn.textContent = "Update Record";
      showToast("Â∑≤ËΩΩÂÖ•ËÆ∞ÂΩïÔºåÂèØÁºñËæëÂêé‰øùÂ≠ò");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteRecord(id) {
      records = records.filter((r) => r.id !== id);
      refreshAll();
      showToast("Â∑≤Âà†Èô§ËÆ∞ÂΩï");
    }

    function handleSaveRecord() {
      const date = dateInput.value || defaultToday();
      const start = startPercentInput.value.trim();
      const end = endPercentInput.value.trim();
      const odo = odoInput.value.trim();
      const rate = rateInput.value.trim();
      const cost = costInput.value.trim();
      const location = getSelectedLocation();

      if (!start || !end || !odo) {
        showToast("Start / End / ODO ÂøÖÈ°ªÂ°´ÂÜô");
        return;
      }

      const startNum = Number(start);
      const endNum = Number(end);
      const odoNum = Number(odo);

      if (
        isNaN(startNum) ||
        isNaN(endNum) ||
        isNaN(odoNum) ||
        startNum < 0 ||
        startNum > 100 ||
        endNum < 0 ||
        endNum > 100
      ) {
        showToast("Start / End / ODO Êï∞ÂÄº‰∏çÂêàÊ≥ï");
        return;
      }

      const rateNum = rate ? Number(rate) : null;
      const costNum = cost ? Number(cost) : null;

      if (rate && isNaN(rateNum)) {
        showToast("Rate Ê†ºÂºèÈîôËØØ");
        return;
      }
      if (cost && isNaN(costNum)) {
        showToast("Cost Ê†ºÂºèÈîôËØØ");
        return;
      }

      const now = Date.now();

      if (editingId) {
        const rec = records.find((r) => r.id === editingId);
        if (rec) {
          rec.date = date;
          rec.start = startNum;
          rec.end = endNum;
          rec.odo = odoNum;
          rec.rate = rateNum;
          rec.cost = costNum;
          rec.location = location;
        }
        ensureLocationExists(location);
        refreshAll();
        clearForm();
        showToast("ËÆ∞ÂΩïÂ∑≤Êõ¥Êñ∞");
      } else {
        const newRec = {
          id: "rec_" + now + "_" + Math.random().toString(16).slice(2),
          createdAt: now,
          date,
          start: startNum,
          end: endNum,
          odo: odoNum,
          rate: rateNum,
          cost: costNum,
          location,
          driveKm: null,
          usedKwh: null,
          whPerKm: null,
        };
        records.push(newRec);
        ensureLocationExists(location);
        refreshAll();
        clearForm();
        showToast("Â∑≤Êñ∞Â¢ûËÆ∞ÂΩï");
        setTimeout(() => {
          tableWrapper.scrollTop = tableWrapper.scrollHeight;
        }, 100);
      }
    }

    function exportCSV() {
      if (!records.length) {
        showToast("Ê≤°ÊúâËÆ∞ÂΩïÂèØÂØºÂá∫");
        return;
      }
      const header =
        "date,start,end,odo,location,rate,cost,driveKm,usedKwh,whPerKm";
      const lines = [header];
      const sorted = getSortedRecords();
      sorted.forEach((rec) => {
        const row = [
          rec.date || "",
          rec.start ?? "",
          rec.end ?? "",
          rec.odo ?? "",
          rec.location ? '"' + String(rec.location).replace(/"/g, '""') + '"' : "",
          rec.rate ?? "",
          rec.cost ?? "",
          rec.driveKm ?? "",
          rec.usedKwh ?? "",
          rec.whPerKm ?? "",
        ];
        lines.push(row.join(","));
      });
      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const today = defaultToday();
      a.href = url;
      a.download = `ev_charge_log_pro_${today}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("CSV Â∑≤ÂØºÂá∫");
    }

    function openImportModal() {
      importModal.classList.add("show");
    }

    function closeImportModal() {
      importModal.classList.remove("show");
      fileInput.value = "";
    }

    function handleFileChosen(mode) {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        importCSVText(text, mode);
      };
      reader.readAsText(file);
    }

    function importCSVText(text, mode) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
      if (!lines.length) {
        showToast("CSV ÂÜÖÂÆπ‰∏∫Á©∫");
        return;
      }
      const headerLine = lines[0];
      const headerFields = headerLine.split(",").map((h) => h.trim());
      const expectedHeader = [
        "date",
        "start",
        "end",
        "odo",
        "location",
        "rate",
        "cost",
        "driveKm",
        "usedKwh",
        "whPerKm",
      ];

      const matchesHeader =
        expectedHeader.length === headerFields.length &&
        expectedHeader.every(
          (h, idx) => h.toLowerCase() === headerFields[idx].toLowerCase()
        );

      let startIdx = 0;
      if (matchesHeader) startIdx = 1;

      const imported = [];
      for (let i = startIdx; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        const cells = [];
        let current = "";
        let inQuotes = false;
        for (let ch of line) {
          if (ch === '"') {
            inQuotes = !inQuotes;
          } else if (ch === "," && !inQuotes) {
            cells.push(current);
            current = "";
          } else {
            current += ch;
          }
        }
        cells.push(current);

        const [date, start, end, odo, location, rate, cost] = cells;

        const newRec = {
          id:
            "imp_" +
            Date.now() +
            "_" +
            i +
            "_" +
            Math.random().toString(16).slice(2),
          createdAt: Date.now() + i,
          date: date || defaultToday(),
          start: start ? Number(start) : null,
          end: end ? Number(end) : null,
          odo: odo ? Number(odo) : null,
          rate: rate ? Number(rate) : null,
          cost: cost ? Number(cost) : null,
          location: location ? location.replace(/^"|"$/g, "") : "",
          driveKm: null,
          usedKwh: null,
          whPerKm: null,
        };

        imported.push(newRec);
      }

      if (!imported.length) {
        showToast("Ê≤°ÊúâÊúâÊïàËÆ∞ÂΩïË¢´ÂØºÂÖ•");
        return;
      }

      if (mode === "replace") {
        records = imported;
      } else {
        records = records.concat(imported);
      }

      imported.forEach((rec) => {
        ensureLocationExists(rec.location);
      });

      refreshAll();
      showToast(
        `CSV Â∑≤ÂØºÂÖ• (${mode === "replace" ? "Ë¶ÜÁõñ" : "ËøΩÂä†"}) ¬∑ ÂÖ± ${
          imported.length
        } Êù°`
      );
    }

    document.addEventListener("DOMContentLoaded", () => {
      dateInput.value = defaultToday();
      loadState();
      updateLocationSelect();
      refreshAll();

      function handleAutoJump(e, nextEl) {
        const v = e.target.value.replace(/\D/g, "");
        e.target.value = v;
        if (v.length >= 2 && nextEl) {
          nextEl.focus();
          nextEl.select?.();
        }
      }

      startPercentInput.addEventListener("input", (e) =>
        handleAutoJump(e, endPercentInput)
      );
      endPercentInput.addEventListener("input", (e) =>
        handleAutoJump(e, odoInput)
      );

      addRecordBtn.addEventListener("click", handleSaveRecord);

      saveLocationBtn.addEventListener("click", () => {
        const loc = locationCustom.value.trim();
        if (!loc) {
          showToast("ËØ∑ËæìÂÖ•Âú∞ÁÇπÂêçÁß∞ÂÜç‰øùÂ≠ò");
          return;
        }
        if (editingLocationIndex !== null) {
          locations[editingLocationIndex] = loc;
          locations.sort((a, b) => a.localeCompare(b));
          editingLocationIndex = null;
          showToast("Âú∞ÁÇπÂ∑≤Êõ¥Êñ∞");
          saveState();
          updateLocationSelect();
          locationSelect.value = loc;
        } else {
          ensureLocationExists(loc);
          locationSelect.value = loc;
          showToast("Âú∞ÁÇπÂ∑≤‰øùÂ≠ò");
        }
      });

      rateChips.forEach((chip) => {
        chip.addEventListener("click", () => {
          const value = chip.getAttribute("data-rate");
          rateChips.forEach((c) => c.classList.remove("selected"));
          chip.classList.add("selected");
          rateInput.value = value === "0" ? "0" : value;
          if (value === "0" && !costInput.value) {
            costInput.value = "0";
          }
        });
      });

      exportBtn.addEventListener("click", exportCSV);
      importBtn.addEventListener("click", openImportModal);
      importCancelBtn.addEventListener("click", closeImportModal);
      importConfirmBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", () => {
        const mode =
          document.querySelector('input[name="importMode"]:checked')?.value ||
          "append";
        handleFileChosen(mode);
        closeImportModal();
      });
    });
  </script>
</body>
</html>
