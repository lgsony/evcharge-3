<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>EV Charge Log Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{--bg:#000;--card:#1c1c1e;--text:#fff;--tesla-red:#E31937;--gray:#333;--border:#2c2c2e;--focus:#007AFF;}
  .dark-mode{--bg:#000000;--card:#0d0d0d;--border:#1a1a1a;--gray:#222;}
  body{margin:0;font-family:-apple-system,sans-serif;background:var(--bg);color:var(--text);
       padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);transition:all 0.3s;}
  .c{max-width:600px;margin:0 auto;padding:0 16px;padding-bottom:120px;}
  header{padding:24px 0 16px;text-align:center;font-size:34px;font-weight:800;color:var(--tesla-red);position:relative;}
  .logo{position:absolute;right:12px;top:18px;width:36px;height:36px;}
  .toggle{position:absolute;right:56px;top:20px;background:rgba(255,255,255,0.1);padding:6px 12px;border-radius:20px;font-size:13px;}
  .card{background:var(--card);border-radius:22px;overflow:hidden;margin:20px 0;box-shadow:0 8px 32px rgba(227,25,55,0.15);border:1px solid var(--border);}
  .section{padding:22px 20px 26px;}
  .section:not(:last-child){border-bottom:1px solid var(--border);}
  input,select{
    width:100%;padding:18px 18px;margin:10px 0;background:#2c2c2e;border:none;
    border-radius:16px;color:white;font-size:18px;box-sizing:border-box;transition:all 0.2s;
  }
  input:focus,select:focus{outline:none;box-shadow:0 0 0 3px var(--focus);background:#333;}
  #location{font-size:19px;font-weight:600;padding:20px 18px;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right 18px center;}
  .row{display:flex;gap:14px;align-items:center;}
  .row > div{flex:1;}
  .btn{background:linear-gradient(180deg,#ff2a47,#e31937);color:white;border:none;padding:20px;border-radius:18px;font-size:20px;font-weight:700;margin-top:18px;box-shadow:0 8px 30px rgba(227,25,55,0.5);}
  .quick-btns{display:flex;flex-wrap:wrap;gap:12px;margin:16px 0 8px;justify-content:center;}
  .qb{padding:12px 20px;background:var(--gray);color:white;border-radius:40px;font-size:17px;font-weight:600;border:1px solid #555;}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:14px 8px;text-align:center;border-bottom:1px solid var(--border);font-size:15px;position:relative;}
  th{color:#aaa;font-weight:500;}
  .action-btn{font-size:20px;cursor:pointer;opacity:0.6;}
  .action-btn:hover{opacity:1;}
  .footer{text-align:center;color:#666;font-size:12px;margin:40px 0 20px;}
  .version{color:#555;font-size:11px;text-align:center;margin-top:50px;}
</style>
</head>
<body>

<div class="c">
  <header>
    EV Charge Log Pro
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e8/Tesla_logo.png/800px-Tesla_logo.png" alt="T" class="logo">
    <div class="toggle" onclick="toggleLang()">中</div>
    <div class="toggle" onclick="toggleDark()" style="right:68px;">黑</div>
  </header>

  <div class="card">
    <div class="section"><input type="date" id="date"></div>

    <div class="section">
      <div class="row">
        <input type="text" inputmode="numeric" id="start" placeholder="Start %" maxlength="2">
        <input type="text" inputmode="numeric" id="end" placeholder="End %" maxlength="3">
      </div>
    </div>

    <div class="section">
      <select id="location">
        <option value="">Select Location</option>
        <option value="__ADD__">+ Add New Location</option>
        <option disabled>────────────────</option>
      </select>
    </div>

    <div class="section">
      <div class="quick-btns">
        <button class="qb" onclick="setRate(0.84)">0.84</button>
        <button class="qb" onclick="setRate(1.00)">1.00</button>
        <button class="qb" onclick="setRate(1.30)">1.30</button>
        <button class="qb" onclick="setRate(1.50)">1.50</button>
        <button class="qb" onclick="setRate(1.80)">1.80</button>
        <button class="qb" onclick="setRate(0)">Free</button>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <input type="number" step="0.001" inputmode="decimal" id="rate" placeholder="Rate (RM/kWh)">
        <input type="number" step="0.01" inputmode="decimal" id="cost" placeholder="Cost (RM) 可不填">
      </div>
    </div>

    <div class="section">
      <button class="btn" onclick="addRecord()">Add Record</button>
    </div>
  </div>

  <!-- 可编辑/删除的记录表格 -->
  <div class="card">
    <div class="section" style="padding-bottom:0;">
      <table>
        <thead><tr><th>Date</th><th>Start</th><th>End</th><th>kWh</th><th>Location</th><th>Rate</th><th>Cost</th><th></th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="section">
      <button class="btn" style="background:#333;" onclick="document.getElementById('importFile').click()">Import CSV</button>
      <button class="btn" onclick="exportAll()">Export All Data</button>
      <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importAll(this)">
    </div>
  </div>

  <div class="version" id="version"></div>
</div>

<script>
const BATTERY_CAPACITY = 60;
const KEYS = {records:'evRecords2025',locations:'evLocations2025',rates:'evRateMemory2025',lang:'evLang2025',dark:'evDark2025'};

let records = JSON.parse(localStorage.getItem(KEYS.records)||'[]');
let allLocations = JSON.parse(localStorage.getItem(KEYS.locations)||'["BH","PV","BAMBOO HILL","HOME","WORK"]');
let rateMemory = JSON.parse(localStorage.getItem(KEYS.rates)||'{}');
let isCN = localStorage.getItem(KEYS.lang)==='cn';
let isUltraDark = localStorage.getItem(KEYS.dark)==='true';
if(isUltraDark)document.body.classList.add('dark-mode');

function toggleLang(){isCN=!isCN;localStorage.setItem(KEYS.lang,isCN?'cn':'en');location.reload();}
function toggleDark(){isUltraDark=!isUltraDark;localStorage.setItem(KEYS.dark,isUltraDark);document.body.classList.toggle('dark-mode',isUltraDark);}

// 自动版本号
function updateVersion(){
  const d=new Date();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  const h=String(d.getHours()).padStart(2,'0');
  const min=String(d.getMinutes()).padStart(2,'0');
  document.getElementById('version').textContent=`Version ${m}${day}-${h}${min}`;
}
updateVersion();

// Start/End 输入逻辑（保持你喜欢的丝滑）
document.getElementById('start').oninput=function(){let v=this.value.replace(/[^0-9]/g,'');if(v.length>2)v=v.slice(0,2);this.value=v;if(v.length===2)setTimeout(()=>document.getElementById('end').focus(),50);};
document.getElementById('end').oninput=function(){let v=this.value.replace(/[^0-9]/g,'');if(v.length>3)v=v.slice(0,3);this.value=v;if(v.length===3||parseInt(v)===100)setTimeout(()=>document.getElementById('location').focus(),50);};

// 地点管理
function renderLocations(){/* 同上，略 */}
// ...（地点长按编辑删除逻辑保持不变）

function autoFillRate(){/* 同上 */}

// 添加记录
function addRecord(){
  // ...（同上添加逻辑）
  renderTable();
  updateVersion();
}

// 表格渲染 + 每行右边有 edit/delete 图标
function renderTable(){
  const tbody=document.getElementById('tableBody');
  tbody.innerHTML='';
  records.slice().reverse().forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.date.split('-').reverse().join('/')}</td>
      <td>${r.start}</td>
      <td>${r.end}</td>
      <td>${r.kwh}</td>
      <td>${r.location}</td>
      <td>${r.rate||'-'}</td>
      <td>${r.cost!=null?'RM'+r.cost.toFixed(2):'-'}</td>
      <td style="width:60px;">
        <span class="action-btn" onclick="editRecord(${records.length-1-i})">Edit</span>
        <span class="action-btn" style="color:#ff453a;margin-left:12px;" onclick="deleteRecord(${records.length-1-i})">Delete</span>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editRecord(idx){
  const r=records[idx];
  document.getElementById('date').value=r.date;
  document.getElementById('start').value=r.start;
  document.getElementById('end').value=r.end;
  document.getElementById('location').value=r.location;
  document.getElementById('rate').value=r.rate||'';
  document.getElementById('cost').value=r.cost||'';
  deleteRecord(idx);
}
function deleteRecord(idx){
  if(confirm('Delete this record?')){
    records.splice(idx,1);
    localStorage.setItem(KEYS.records,JSON.stringify(records));
    renderTable();
  }
}

// 初始化
document.getElementById('date').value=new Date().toISOString().slice(0,10);
renderLocations();
renderTable();
document.getElementById('start').focus();
</script>
</body>
</html>
