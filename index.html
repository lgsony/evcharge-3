<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>EV Charge Log Pro ¬∑ 60 kWh</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <style>
    :root {
      --bg: #050507;
      --card-bg: #151518;
      --card-bg-soft: #18181c;
      --border-subtle: #26262b;
      --accent: #e82127;
      --accent-soft: #ff4d57;
      --text-main: #ffffff;
      --text-sub: #bbbbc0;
      --text-muted: #777782;
      --chip-bg: #222228;
      --chip-border: #3a3a42;
      --danger: #ff4b5c;
      --success: #18c37d;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a1a1f 0, #050507 55%, #000 100%);
      color: var(--text-main);
      overflow: hidden; /* ÈîÅ‰Ωè bodyÔºåÂè™ËÆ©ÂÜÖÈÉ®ÂÆπÂô®ÊªöÂä® */
    }

    .app-shell {
      height: 100vh;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .app-scroll {
      flex: 1;
      width: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 24px 12px 84px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 840px;
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }

    header .sub {
      font-size: 12px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent-soft);
    }

    .card {
      background: radial-gradient(circle at top left, #26222a 0, #151518 50%);
      border-radius: 18px;
      padding: 16px 16px 14px;
      border: 1px solid #26222a;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      margin-bottom: 14px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field {
      margin-bottom: 12px;
    }

    .field label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--text-sub);
    }

    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-row input[type="date"] {
      flex: 1;
    }

    .date-icon {
      font-size: 16px;
      opacity: 0.6;
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #111115;
      color: var(--text-main);
      font-size: 16px; /* >=16 ÈÅøÂÖç iOS Ëá™Âä®ÊîæÂ§ß */
      outline: none;
    }

    input::placeholder {
      color: var(--text-muted);
    }

    input:focus,
    select:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(255, 77, 87, 0.7);
    }

    .inline-two {
      display: flex;
      gap: 10px;
    }

    .inline-two .field {
      flex: 1;
      margin-bottom: 0;
    }

    .right-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-left: 6px;
    }

    .location-row {
      display: flex;
      gap: 8px;
    }

    .location-row > div:first-child {
      flex: 1;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      font-size: 12px;
      color: var(--text-sub);
      cursor: pointer;
      user-select: none;
    }

    .chip.active {
      border-color: var(--accent-soft);
      color: var(--accent-soft);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
    }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, #ff4050, #e82127);
      color: #fff;
      box-shadow: 0 14px 30px rgba(232, 33, 39, 0.65);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 10px 22px rgba(232, 33, 39, 0.5);
    }

    .btn-soft {
      background: #19191d;
      color: #e2e2e7;
      border-radius: 18px;
      padding-inline: 18px;
      font-size: 14px;
      border: 1px solid #2b2b31;
    }

    .btn-soft .icon {
      margin-right: 6px;
      opacity: 0.9;
    }

    .bottom-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px 14px 12px;
      background: linear-gradient(to top, #000 0, rgba(0, 0, 0, 0.2));
      backdrop-filter: blur(10px);
      z-index: 12;
    }

    .bottom-inner {
      max-width: 840px;
      margin: 0 auto;
      display: flex;
      justify-content: flex-start;
    }

    .bottom-group {
      display: flex;
      gap: 10px;
    }

    .prev-info {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: left;
    }

    .prev-info span {
      color: #f5f5f5;
    }

    .table-wrapper {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid #26222a;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 360px;
      background: #101013;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 760px; /* ÊâãÊú∫ÂèØÊ®™ÊªëÔºåÊ°åÈù¢Èì∫Êª° */
    }

    thead {
      background: #18181d;
    }

    th,
    td {
      padding: 8px 6px;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child {
      text-align: left;
      padding-left: 10px;
    }

    th:last-child,
    td:last-child {
      padding-right: 10px;
    }

    tbody tr:nth-child(even) {
      background: #141419;
    }

    tbody tr:nth-child(odd) {
      background: #0f0f13;
    }

    .td-location {
      max-width: 130px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .td-actions {
      text-align: right;
      font-size: 15px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .action-icon {
      cursor: pointer;
      opacity: 0.65;
    }

    .action-icon:hover {
      opacity: 1;
    }

    .empty-state {
      padding: 12px;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .loc-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 4px;
      border-bottom: 1px solid #25252a;
      font-size: 13px;
    }

    .loc-row:last-child {
      border-bottom: none;
    }

    .loc-actions {
      display: flex;
      gap: 8px;
      font-size: 16px;
    }

    .loc-empty {
      padding: 8px 2px 2px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .badge-count {
      font-size: 11px;
      color: var(--text-muted);
    }

    .summary-month {
      padding: 6px 4px;
      border-bottom: 1px solid #25252a;
      font-size: 12px;
    }

    .summary-month:last-child {
      border-bottom: none;
    }

    .summary-header-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .summary-month-title {
      font-weight: 600;
      font-size: 13px;
    }

    .summary-body {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      color: var(--text-sub);
    }

    .summary-item {
      min-width: 90px;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 72px;
      transform: translateX(-50%);
      background: rgba(10, 10, 14, 0.95);
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
      border: 1px solid #33333a;
      z-index: 30;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .popup-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 25;
    }

    .popup-card {
      width: 90%;
      max-width: 360px;
      background: #16161b;
      border-radius: 18px;
      border: 1px solid #34343e;
      padding: 16px 16px 14px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
    }

    .popup-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .popup-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .popup-options {
      margin-bottom: 10px;
    }

    .popup-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 4px;
      font-size: 13px;
      cursor: pointer;
    }

    .popup-option span {
      color: var(--text-main);
    }

    .popup-option input[type="radio"] {
      accent-color: var(--accent-soft);
    }

    .popup-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .popup-btn-cancel {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid #33333a;
      background: #15151a;
      color: var(--text-sub);
      font-size: 13px;
      cursor: pointer;
    }

    .popup-btn-primary {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      background: linear-gradient(135deg, #ff4050, #e82127);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(232, 33, 39, 0.7);
    }

    footer {
      text-align: center;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (min-width: 520px) {
      header h1 {
        font-size: 24px;
      }
      table {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="toast"></div>

  <!-- Import popup -->
  <div id="importModal" class="popup-backdrop">
    <div class="popup-card">
      <div class="popup-title">Import CSV</div>
      <div class="popup-sub">ÈÄâÊã©ÂØºÂÖ•ÊñπÂºè:</div>

      <div class="popup-options">
        <label class="popup-option">
          <input type="radio" name="importMode" value="append" checked />
          <span>ËøΩÂä† (Append)</span>
        </label>
        <label class="popup-option">
          <input type="radio" name="importMode" value="replace" />
          <span>Ë¶ÜÁõñ (Replace)</span>
        </label>
      </div>

      <div class="popup-buttons">
        <button class="popup-btn-cancel" id="importCancelBtn">ÂèñÊ∂à</button>
        <button class="popup-btn-primary" id="importConfirmBtn">ÈÄâÊã©Êñá‰ª∂</button>
      </div>
    </div>
  </div>

  <div class="app-shell">
    <div class="app-scroll">
      <div class="app">
        <header>
          <div class="sub">TESLA ¬∑ MODEL Y RWD VER.0912-1052</div>
          <h1>EV Charge Log Pro</h1>
        </header>

        <!-- Main form -->
        <section class="card">
          <div class="field">
            <label>Date</label>
            <div class="date-row">
              <input id="dateInput" type="date" />
              <div class="date-icon">üìÖ</div>
            </div>
          </div>

          <div class="inline-two" style="margin-bottom:8px;">
            <div class="field">
              <label>Start %</label>
              <input
                id="startPercent"
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="2"
                placeholder="Start %"
              />
            </div>
            <div class="field">
              <label>End %</label>
              <input
                id="endPercent"
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="2"
                placeholder="End %"
              />
            </div>
          </div>

          <div class="field">
            <label>ODO (km) <span class="right-label">ÂèØÁ©∫</span></label>
            <input
              id="odoInput"
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              placeholder="ÂèØ‰∏çÂ°´Ôºå‰æãÂ¶Ç 12850"
            />
          </div>

          <div class="field">
            <label>
              Select Location
              <span class="badge-count" id="locationCount"></span>
            </label>
            <select id="locationSelect">
              <option value="">ËØ∑ÈÄâÊã©Âú∞ÁÇπ</option>
            </select>
          </div>

          <div class="field">
            <label>Add / Edit Location</label>
            <div class="location-row">
              <div>
                <input
                  id="locationCustom"
                  type="text"
                  placeholder="‰æãÂ¶Ç HOME, PV-KL, BAMBOO HILL..."
                />
              </div>
              <button class="btn-soft" id="saveLocationBtn">‰øùÂ≠òÂú∞ÁÇπ</button>
            </div>
          </div>

          <div class="field">
            <label>Rate (RM/kWh)</label>
            <div class="chips-row">
              <div class="chip" data-rate="0.84">0.84</div>
              <div class="chip" data-rate="1.00">1.00</div>
              <div class="chip" data-rate="1.30">1.30</div>
              <div class="chip" data-rate="1.50">1.50</div>
              <div class="chip" data-rate="1.80">1.80</div>
              <div class="chip" data-rate="0">Free</div>
            </div>
            <div class="inline-two">
              <div class="field">
                <label>Rate (RM/kWh)</label>
                <input
                  id="rateInput"
                  type="text"
                  inputmode="decimal"
                  placeholder="‰æãÂ¶Ç 1.50"
                />
              </div>
              <div class="field">
                <label>Cost (RM)</label>
                <input
                  id="costInput"
                  type="text"
                  inputmode="decimal"
                  placeholder="‰æãÂ¶Ç 18.90"
                />
              </div>
            </div>
          </div>

          <button class="btn btn-primary" id="addRecordBtn">Add Record</button>

          <div class="prev-info" id="prevInfo">
            ‰∏ä‰∏ÄÊù°ËÆ∞ÂΩï: <span>ÊöÇÊó†</span>
          </div>
        </section>

        <!-- Charge log -->
        <section class="card">
          <div class="card-header-row">
            <div class="card-title">Charge Log</div>
            <div class="card-sub">
              Date / Start / End / Used kWh / KM / Wh/km / Location / Rate / Cost / Edit¬∑Delete
            </div>
          </div>

          <div class="table-wrapper" id="tableWrapper">
            <table>
              <thead>
                <tr>
                  <th>DATE</th>
                  <th>START%</th>
                  <th>END%</th>
                  <th>USED kWh</th>
                  <th>KM</th>
                  <th>Wh/km</th>
                  <th>Location</th>
                  <th>Rate</th>
                  <th>Cost</th>
                  <th>‚ãØ</th>
                </tr>
              </thead>
              <tbody id="recordsBody"></tbody>
            </table>
          </div>
          <div id="emptyState" class="empty-state" style="display:none;">
            ËøòÊ≤°ÊúâËÆ∞ÂΩï„ÄÇ‰∏äÈù¢Â°´ÂÜô‰∏ÄÊ¨°ÂÖÖÁîµÊï∞ÊçÆÔºåÁÑ∂ÂêéÁÇπ„ÄåAdd Record„Äç„ÄÇ
          </div>
        </section>

        <!-- Monthly summary -->
        <section class="card">
          <div class="card-header-row">
            <div class="card-title">Monthly Summary (60 kWh pack)</div>
          </div>
          <div id="summaryContainer" class="summary-container">
            <div class="empty-state">No drive data yet</div>
          </div>
        </section>

        <!-- Saved locations -->
        <section class="card">
          <div class="card-header-row">
            <div class="card-title">Saved Locations</div>
          </div>
          <div id="locationsList">
            <div class="loc-empty">ÊöÇÊó∂Ê≤°Êúâ‰øùÂ≠òÁöÑÂú∞ÁÇπ„ÄÇ</div>
          </div>
        </section>

        <footer>Version v4-ODO-20251207</footer>
      </div>
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottom-bar">
    <div class="bottom-inner">
      <div class="bottom-group">
        <button class="btn btn-soft" id="exportBtn">
          <span class="icon">‚á£</span> Export
        </button>
        <button class="btn btn-soft" id="importBtn">
          <span class="icon">‚á°</span> Import
        </button>
      </div>
    </div>
  </div>

  <input id="fileInput" type="file" accept=".csv,text/csv" style="display:none;" />

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // === 1. Â°´ÂÖ•‰Ω†ÁöÑ Firebase configÔºà‰ªé Firebase ÊéßÂà∂Âè∞Â§çÂà∂Ôºâ ===
const firebaseConfig = {
  apiKey: "AIzaSyCbqYoEXpNIqq076dCin3vcVzCKP5E3gVY",
  authDomain: "evcharge3-3a6e9.firebaseapp.com",
  projectId: "evcharge3-3a6e9",
  storageBucket: "evcharge3-3a6e9.firebasestorage.app",
  messagingSenderId: "525208875638",
  appId: "1:525208875638:web:f6ecb552e2ac08ef336557"
};

  // === 2. ÂàùÂßãÂåñ Firebase / Firestore ===
  const fbApp = initializeApp(firebaseConfig);
  const db = getFirestore(fbApp);
  const cloudDocRef = doc(db, "evChargeLogPro", "main"); // ‰∏Ä‰∏™ collection, ‰∏Ä‰∏™ document

  // Êú¨Âú∞Êõ¥Êñ∞Êó∂Èó¥ÔºàÁî®Êù•Âà§Êñ≠Ë∞ÅÊØîËæÉÊñ∞Ôºâ
  let lastUpdated = Number(
    localStorage.getItem("evChargeLogPro_updatedAt") || 0
  );
  let isApplyingCloud = false; // ÈÅøÂÖç snapshot ‚Üí refreshAll ‚Üí ÂÜçÂÜôÂõû cloud ÈÄ†ÊàêÊ≠ªÂæ™ÁéØ

  // ====== ‰∏ãÈù¢ÂºÄÂßãÊòØ‰Ω†ÂéüÊú¨ÁöÑÈÄªËæë + ‰∫ëÂêåÊ≠•Êï¥Âêà ======

  const BATTERY_KWH = 60;
  const STORAGE_KEY_RECORDS = "evChargeLogPro_v5_records";
  const STORAGE_KEY_LOCATIONS = "evChargeLogPro_v5_locations";

  function getLastRateForLocation(loc, records) {
    if (!loc) return null;
    const target = String(loc).trim().toLowerCase();
    const sorted = [...records].sort((a, b) => {
      if (a.date === b.date) return (a.createdAt || 0) - (b.createdAt || 0);
      return a.date < b.date ? -1 : 1;
    });
    for (let i = sorted.length - 1; i >= 0; i--) {
      const r = sorted[i];
      const rLoc = (r.location || "").trim().toLowerCase();
      if (rLoc === target && typeof r.rate === "number" && !isNaN(r.rate)) {
        return r.rate;
      }
    }
    return null;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const dateInput = document.getElementById("dateInput");
    const startPercentInput = document.getElementById("startPercent");
    const endPercentInput = document.getElementById("endPercent");
    const odoInput = document.getElementById("odoInput");
    const locationSelect = document.getElementById("locationSelect");
    const locationCustom = document.getElementById("locationCustom");
    const locationCount = document.getElementById("locationCount");
    const rateInput = document.getElementById("rateInput");
    const costInput = document.getElementById("costInput");
    const addRecordBtn = document.getElementById("addRecordBtn");
    const saveLocationBtn = document.getElementById("saveLocationBtn");
    const prevInfo = document.getElementById("prevInfo");

    const recordsBody = document.getElementById("recordsBody");
    const emptyState = document.getElementById("emptyState");
    const summaryContainer = document.getElementById("summaryContainer");
    const locationsList = document.getElementById("locationsList");
    const tableWrapper = document.getElementById("tableWrapper");

    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const toastEl = document.getElementById("toast");

    const importModal = document.getElementById("importModal");
    const importCancelBtn = document.getElementById("importCancelBtn");
    const importConfirmBtn = document.getElementById("importConfirmBtn");
    const fileInput = document.getElementById("fileInput");

    const rateChips = document.querySelectorAll(".chip[data-rate]");

    let records = [];
    let locations = [];
    let editingId = null;
    let editingLocationIndex = null;
    let currentImportMode = "append";

    function showToast(msg, duration = 2000) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, duration);
    }

    function defaultToday() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function loadState() {
      try {
        const recStr = localStorage.getItem(STORAGE_KEY_RECORDS);
        records = recStr ? JSON.parse(recStr) : [];
      } catch {
        records = [];
      }

      // migrate old records (add id/createdAt if missing)
      let changed = false;
      const now = Date.now();
      records.forEach((r, idx) => {
        if (!r.id) {
          r.id = "rec_migr_" + now + "_" + idx;
          changed = true;
        }
        if (typeof r.createdAt !== "number") {
          r.createdAt = now + idx;
          changed = true;
        }
      });
      if (changed) {
        localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
      }

      try {
        const locStr = localStorage.getItem(STORAGE_KEY_LOCATIONS);
        locations = locStr ? JSON.parse(locStr) : [];
      } catch {
        locations = [];
      }
    }

    function saveStateOnlyLocal() {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
      localStorage.setItem(STORAGE_KEY_LOCATIONS", JSON.stringify(locations));
    }

    // === ‰∫ëÂêåÊ≠•ÔºöÊääÂΩìÂâç records / locations Êé®‰∏ä Firestore ===
    async function syncCloud() {
      if (!db || !cloudDocRef) return;
      if (isApplyingCloud) return; // Ê≠£Âú®Â•óÁî®‰∫ëÁ´ØËµÑÊñôÊó∂‰∏çË¶ÅÂÜçÂÜôÂõûÂéª

      try {
        lastUpdated = Date.now();
        localStorage.setItem(
          "evChargeLogPro_updatedAt",
          String(lastUpdated)
        );
        await setDoc(
          cloudDocRef,
          {
            records,
            locations,
            updatedAt: lastUpdated,
          },
          { merge: true }
        );
      } catch (err) {
        console.error("syncCloud error:", err);
      }
    }

    function getSortedRecordsAsc() {
      return [...records].sort((a, b) => {
        if (a.date === b.date) return (a.createdAt || 0) - (b.createdAt || 0);
        return a.date < b.date ? -1 : 1;
      });
    }

    function getSortedRecordsDesc() {
      return [...records].sort((a, b) => {
        if (a.date === b.date) {
          return (b.createdAt || 0) - (a.createdAt || 0);
        }
        return a.date > b.date ? -1 : 1;
      });
    }

    function recomputeDriveStats() {
      const sorted = getSortedRecordsAsc();
      let prev = null;
      sorted.forEach((rec) => {
        rec.driveKm = null;
        rec.usedKwh = null;
        rec.whPerKm = null;

        if (prev) {
          if (
            typeof prev.end === "number" &&
            typeof rec.start === "number" &&
            !isNaN(prev.end) &&
            !isNaN(rec.start)
          ) {
            const diffPct = prev.end - rec.start;
            if (diffPct > 0) {
              const used = (BATTERY_KWH * diffPct) / 100;
              rec.usedKwh = used;
            }
          }

          if (
            typeof prev.odo === "number" &&
            typeof rec.odo === "number" &&
            !isNaN(prev.odo) &&
            !isNaN(rec.odo)
          ) {
            const km = rec.odo - prev.odo;
            if (km > 0) rec.driveKm = km;
          }

          if (rec.driveKm && rec.usedKwh) {
            const wh = (rec.usedKwh * 1000) / rec.driveKm;
            if (wh > 0) rec.whPerKm = wh;
          }
        }

        prev = rec;
      });
    }

    function formatNumber(num, decimals) {
      if (num === null || num === undefined || isNaN(num)) return "-";
      return Number(num).toFixed(decimals);
    }

    function updateLocationSelect() {
      locationSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Âú∞ÁÇπ</option>';
      locations.forEach((loc) => {
        const opt = document.createElement("option");
        opt.value = loc;
        opt.textContent = loc;
        locationSelect.appendChild(opt);
      });
      if (locations.length) {
        locationCount.textContent = `${locations.length} saved`;
      } else {
        locationCount.textContent = "";
      }
    }

    function renderLocationsList() {
      locationsList.innerHTML = "";
      if (!locations.length) {
        const div = document.createElement("div");
        div.className = "loc-empty";
        div.textContent = "ÊöÇÊó∂Ê≤°Êúâ‰øùÂ≠òÁöÑÂú∞ÁÇπ„ÄÇ";
        locationsList.appendChild(div);
        return;
      }
      locations.forEach((loc, idx) => {
        const row = document.createElement("div");
        row.className = "loc-row";

        const nameDiv = document.createElement("div");
        nameDiv.textContent = loc;

        const actions = document.createElement("div");
        actions.className = "loc-actions";

        const editSpan = document.createElement("span");
        editSpan.className = "action-icon";
        editSpan.textContent = "‚úèÔ∏è";
        editSpan.dataset.action = "editLocation";
        editSpan.dataset.index = idx;

        const delSpan = document.createElement("span");
        delSpan.className = "action-icon";
        delSpan.textContent = "üóëÔ∏è";
        delSpan.dataset.action = "deleteLocation";
        delSpan.dataset.index = idx;

        actions.appendChild(editSpan);
        actions.appendChild(delSpan);
        row.appendChild(nameDiv);
        row.appendChild(actions);

        locationsList.appendChild(row);
      });
    }

    function renderPrevInfo() {
      if (!records.length) {
        prevInfo.innerHTML = '‰∏ä‰∏ÄÊù°ËÆ∞ÂΩï: <span>ÊöÇÊó†</span>';
        return;
      }
      const sorted = getSortedRecordsAsc();
      const last = sorted[sorted.length - 1];
      const date = last.date || "-";
      const end = last.end != null ? `${last.end}%` : "-";
      const odo =
        last.odo != null && !isNaN(last.odo) ? `${last.odo} km` : "-";
      prevInfo.innerHTML = `‰∏ä‰∏ÄÊù°ËÆ∞ÂΩï: <span>${date}</span> ¬∑ End <span>${end}</span> ¬∑ ODO <span>${odo}</span>`;
    }

    function renderTable() {
      recordsBody.innerHTML = "";
      const sorted = getSortedRecordsDesc();
      if (!sorted.length) {
        tableWrapper.style.display = "none";
        emptyState.style.display = "block";
        return;
      }
      tableWrapper.style.display = "block";
      emptyState.style.display = "none";

      sorted.forEach((rec) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = rec.date || "-";
        tr.appendChild(tdDate);

        const tdStart = document.createElement("td");
        tdStart.textContent =
          rec.start != null && !isNaN(rec.start) ? rec.start : "-";
        tr.appendChild(tdStart);

        const tdEnd = document.createElement("td");
        tdEnd.textContent =
          rec.end != null && !isNaN(rec.end) ? rec.end : "-";
        tr.appendChild(tdEnd);

        const tdUsed = document.createElement("td");
        tdUsed.textContent =
          rec.usedKwh != null ? formatNumber(rec.usedKwh, 2) : "-";
        tr.appendChild(tdUsed);

        const tdKm = document.createElement("td");
        tdKm.textContent =
          rec.driveKm != null ? formatNumber(rec.driveKm, 0) : "-";
        tr.appendChild(tdKm);

        const tdWh = document.createElement("td");
        tdWh.textContent =
          rec.whPerKm != null ? formatNumber(rec.whPerKm, 0) : "-";
        tr.appendChild(tdWh);

        const tdLoc = document.createElement("td");
        tdLoc.className = "td-location";
        tdLoc.textContent = rec.location || "-";
        tr.appendChild(tdLoc);

        const tdRate = document.createElement("td");
        tdRate.textContent =
          rec.rate != null && !isNaN(rec.rate)
            ? formatNumber(rec.rate, 2)
            : "-";
        tr.appendChild(tdRate);

        const tdCost = document.createElement("td");
        tdCost.textContent =
          rec.cost != null && !isNaN(rec.cost)
            ? formatNumber(rec.cost, 2)
            : "-";
        tr.appendChild(tdCost);

        const tdActions = document.createElement("td");
        tdActions.className = "td-actions";

        const editSpan = document.createElement("span");
        editSpan.className = "action-icon";
        editSpan.textContent = "‚úèÔ∏è";
        editSpan.dataset.action = "edit";
        editSpan.dataset.id = rec.id;

        const delSpan = document.createElement("span");
        delSpan.className = "action-icon";
        delSpan.textContent = "üóëÔ∏è";
        delSpan.dataset.action = "delete";
        delSpan.dataset.id = rec.id;

        tdActions.appendChild(editSpan);
        tdActions.appendChild(delSpan);
        tr.appendChild(tdActions);

        recordsBody.appendChild(tr);
      });
    }

    function renderMonthlySummary() {
      summaryContainer.innerHTML = "";
      if (!records.length) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent = "No drive data yet";
        summaryContainer.appendChild(div);
        return;
      }

      const byMonth = {};
      records.forEach((rec) => {
        if (!rec.date) return;
        const ym = rec.date.slice(0, 7);
        if (!byMonth[ym]) {
          byMonth[ym] = { totalRm: 0, totalKwh: 0, totalKm: 0 };
        }
        const m = byMonth[ym];
        if (rec.cost) m.totalRm += Number(rec.cost) || 0;
        if (rec.usedKwh) m.totalKwh += Number(rec.usedKwh) || 0;
        if (rec.driveKm) m.totalKm += Number(rec.driveKm) || 0;
      });

      const months = Object.keys(byMonth).sort().reverse();
      months.forEach((ym) => {
        const m = byMonth[ym];
        const wrap = document.createElement("div");
        wrap.className = "summary-month";

        const header = document.createElement("div");
        header.className = "summary-header-row";

        const title = document.createElement("div");
        title.className = "summary-month-title";
        title.textContent = ym.replace("-", "/");

        const whSpan = document.createElement("div");
        let wh = "-";
        if (m.totalKm > 0 && m.totalKwh > 0) {
          wh = ((m.totalKwh * 1000) / m.totalKm).toFixed(0);
        }
        whSpan.textContent = `Wh/km: ${wh}`;

        header.appendChild(title);
        header.appendChild(whSpan);

        const body = document.createElement("div");
        body.className = "summary-body";

        const itemRm = document.createElement("div");
        itemRm.className = "summary-item";
        itemRm.textContent = `ÊÄª RM: ${m.totalRm.toFixed(2)}`;

        const itemKwh = document.createElement("div");
        itemKwh.className = "summary-item";
        itemKwh.textContent = `ÊÄª used kWh: ${m.totalKwh.toFixed(2)}`;

        const itemKm = document.createElement("div");
        itemKm.className = "summary-item";
        itemKm.textContent = `ÊÄª KM: ${m.totalKm.toFixed(0)}`;

        body.appendChild(itemRm);
        body.appendChild(itemKwh);
        body.appendChild(itemKm);

        wrap.appendChild(header);
        wrap.appendChild(body);

        summaryContainer.appendChild(wrap);
      });
    }

    // ÊÄªÂà∑Êñ∞ÔºöÂèØÈÄâÊã©ÊòØÂê¶ÂÜôÂõû Cloud
    function refreshAll(skipCloud = false) {
      recomputeDriveStats();
      renderTable();
      renderMonthlySummary();
      renderPrevInfo();
      saveStateOnlyLocal();
      if (!skipCloud) {
        syncCloud();
      }
    }

    function clearForm() {
      startPercentInput.value = "";
      endPercentInput.value = "";
      odoInput.value = "";
      rateInput.value = "";
      costInput.value = "";
      editingId = null;
      addRecordBtn.textContent = "Add Record";
    }

    function ensureLocationExists(loc) {
      const v = (loc || "").trim();
      if (!v) return;
      if (!locations.includes(v)) {
        locations.push(v);
        locations.sort((a, b) => a.localeCompare(b));
        saveStateOnlyLocal();
      }
    }

    // ====== Export / ImportÔºà‰øùÊåÅÂéüÊú¨ÈÄªËæëÔºå‰∏çÂÜçËµòËø∞Ôºâ ======
    // ËøôÈáå‰Ω†ÂèØ‰ª•ÁªßÁª≠Áî®‰Ω†Áé∞Âú®ÈÇ£ÊÆµ exportCSV / importCSVText / parseCsvLine Á≠âÂáΩÊï∞
    // Ë∞ÉÊï¥ÔºöÂú®ÈúÄË¶ÅÁöÑÂú∞ÊñπÔºåÊääÂéüÊú¨ refreshAll() ÊîπÊàê refreshAll() Â∞±Â•ΩÔºà‰ºöËá™Âä®ÂêåÊ≠• CloudÔºâ

    // ‚Ä¶‚Ä¶Ôºà‰∏∫‰∫Ü‰∏çËÆ©ËÆØÊÅØÂ§™ÈïøÔºåËøôÈáåÁúÅÁï•‰Ω†ÂéüÊú¨ÁöÑ Import / Export ‰ª£Á†ÅÔºå
    // ‰Ω†ÂèØ‰ª•ÊääÊàë‰πãÂâçÁªô‰Ω†ÁöÑÊúÄÊñ∞Áâà script ÈáåÁõ∏ÂÖ≥ÈÉ®ÂàÜÁõ¥Êé•Êê¨ËøõÊù•Ôºå
    // ÂîØ‰∏ÄË¶ÅÊîπÁöÑÊòØÔºöÊâÄÊúâÂú∞ÊñπË∞ÉÁî® refreshAll() ÁöÑÔºåÈÉΩ‰∏çË¶Å‰º†ÂèÇÊï∞Ôºå
    // ËÆ©ÂÆÉÈªòËÆ§ syncCloudÔºâ‚Ä¶‚Ä¶

    // ==== ÂàùÂßãÂåñ ====
    dateInput.value = defaultToday();
    loadState();
    updateLocationSelect();
    renderLocationsList();
    // ÂÖàÁî®Êú¨Âú∞Êï∞ÊçÆÊ∏≤Êüì‰∏ÄÊ¨°Ôºå‰ΩÜ‰∏çÊé®‰∏ä‰∫ëÁ´Ø
    refreshAll(true);

    // ==== ÂàùÂßãÂåñ CloudÔºåÂêåÊ≠•Á≠ñÁï•ÔºöË∞ÅÊñ∞Âê¨Ë∞ÅÁöÑ ====
    (async () => {
      try {
        const snap = await getDoc(cloudDocRef);
        if (snap.exists()) {
          const data = snap.data() || {};
          const cloudUpdated = Number(data.updatedAt || 0);
          if (cloudUpdated > lastUpdated) {
            // ‰∫ëÁ´ØÊØîÊú¨Âú∞Êñ∞ ‚Üí Â•óÁî®‰∫ëÁ´Ø
            isApplyingCloud = true;
            records = data.records || [];
            locations = data.locations || [];
            lastUpdated = cloudUpdated;
            localStorage.setItem(
              "evChargeLogPro_updatedAt",
              String(lastUpdated)
            );
            updateLocationSelect();
            renderLocationsList();
            refreshAll(true); // Â•óÁî®‰∫ëÁ´Ø‰ΩÜ‰∏çË¶ÅÂÜçÂÜôÂõû‰∫ëÁ´Ø
            isApplyingCloud = false;
          } else {
            // Êú¨Âú∞ÊØîËæÉÊñ∞ ‚Üí Êé®Âà∞‰∫ëÁ´Ø
            syncCloud();
          }
        } else {
          // ‰∫ëÁ´ØËøòÊ≤°ËµÑÊñô ‚Üí ‰ª•Êú¨Âú∞‰∏∫ÂáÜÊé®‰∏äÂéª
          syncCloud();
        }

        // ÂÆûÊó∂ÁõëÂê¨ÔºöÂà´ÁöÑË£ÖÁΩÆÊõ¥Êñ∞Êó∂Ëá™Âä®Êãâ‰∏ãÊù•
        onSnapshot(cloudDocRef, (snap2) => {
          if (!snap2.exists()) return;
          const data2 = snap2.data() || {};
          const cloudUpdated2 = Number(data2.updatedAt || 0);
          if (cloudUpdated2 <= lastUpdated) return; // ÊØîÊàë‰ª¨ÊóßÊàñ‰∏ÄÊ†∑Â∞±ÂøΩÁï•

          isApplyingCloud = true;
          records = data2.records || [];
          locations = data2.locations || [];
          lastUpdated = cloudUpdated2;
          localStorage.setItem(
            "evChargeLogPro_updatedAt",
            String(lastUpdated)
          );
          updateLocationSelect();
          renderLocationsList();
          refreshAll(true); // Áî®‰∫ëÁ´ØËµÑÊñôÈáçÁÆóÔºå‰ΩÜ‰∏çÂÜôÂõû‰∫ëÁ´Ø
          isApplyingCloud = false;
        });
      } catch (e) {
        console.error("init cloud error:", e);
      }
    })();

    // ‰∏ãÈù¢ÁªßÁª≠Êé•‰Ω†ÁöÑ‰∫ã‰ª∂ÁªëÂÆöÔºöStart%/End% Ëá™Âä®Ë∑≥„ÄÅAdd Record„ÄÅEdit/Delete„ÄÅImport/Export‚Ä¶
    // ÊâÄÊúâ„ÄåÊï∞ÊçÆÊúâÊîπÂèò„ÄçÁöÑÂú∞ÊñπÔºåÂè™Ë¶ÅÊúÄÂêéË∞ÉÁî® refreshAll() Â∞±‰ºöÂêåÊó∂Â≠ò local + Cloud„ÄÇ
  });
</script>

  
</body>
</html>
