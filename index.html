<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>EV Charge Log Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --bg:#000;
    --card:#1c1c1e;
    --text:#fff;
    --tesla-red:#E31937;
    --gray:#333;
    --border:#2c2c2e;
    --focus:#007AFF;
  }

  body{
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    background:var(--bg);
    color:var(--text);
    padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    transition:all .25s;
  }

  .c{
    max-width:600px;
    margin:0 auto;
    padding:0 16px 120px;
  }

  /* HEADER */
  header{
    padding:32px 0 20px;
    text-align:center;
    font-size:34px;
    font-weight:800;
    color:var(--tesla-red);
    position:relative;
  }

  /* CARD */
  .card{
    background:var(--card);
    border-radius:22px;
    overflow:hidden;
    margin:22px 0;
    border:1px solid var(--border);
    box-shadow:0 8px 32px rgba(227,25,55,0.12);
  }

  .section{
    padding:22px 20px 26px;
  }
  .section:not(:last-child){
    border-bottom:1px solid var(--border);
  }

  /* INPUTS */
  input, select{
    width:100%;
    padding:18px;
    height:58px;              /* 统一高度 */
    border:none;
    border-radius:16px;
    background:#2c2c2e;
    color:white;
    font-size:18px;
    box-sizing:border-box;
    transition:.2s;
  }
  input:focus, select:focus{
    background:#3a3a3c;
    outline:none;
    box-shadow:0 0 0 3px var(--focus);
  }

  #location{
    font-weight:600;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 18px center;
  }
  #location option[data-divider]{
    height:1px;
    background:#444;
    margin:8px 16px;
    pointer-events:none;
  }

  .row{ display:flex; gap:14px; }
  .row > input { flex:1; }

  /* QUICK RATE BUTTONS */
  .quick-btns{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    justify-content:center;
  }
  .qb{
    padding:12px 22px;
    background:var(--gray);
    border-radius:40px;
    color:white;
    font-size:17px;
    border:1px solid #555;
    cursor:pointer;
  }

  /* BUTTONS */
  .btn{
    width:100%;
    background:linear-gradient(180deg,#ff2a47,#e31937);
    color:white;
    border:none;
    padding:20px;
    border-radius:18px;
    font-size:20px;
    font-weight:700;
    margin-top:18px;
    cursor:pointer;
    box-shadow:0 8px 30px rgba(227,25,55,0.45);
  }
  .btn.secondary{
    background:#333;
    padding:16px;
    font-size:16px;
    box-shadow:none;
    display:none;
  }

  /* TABLE */
  .table-wrapper{
    overflow:auto;
    border-radius:16px;
  }
  table{
    width:100%;
    min-width:720px;
    border-collapse:separate;
    border-spacing:0;
  }
  th,td{
    padding:16px 10px;
    text-align:center;
    border-bottom:1px solid var(--border);
    border-right:1px solid var(--border);
    font-size:15px;
  }
  th:last-child,td:last-child{ border-right:none; }
  th{ background:#252525; color:#aaa; font-weight:600; }
  tr:last-child td{ border-bottom:none; }
  .empty-row{
    text-align:center;
    padding:16px;
    color:#777;
  }

  /* ACTION ICONS */
  .action{
    font-size:18px;
    cursor:pointer;
    opacity:.7;
    margin:0 4px;
  }
  .action:hover{ opacity:1; }

  /* LOCATION LIST */
  .loc-row{
    display:flex;
    justify-content:space-between;
    padding:10px 0;
    border-bottom:1px solid var(--border);
  }
  .loc-row:last-child{ border-bottom:none; }
  .loc-name{ font-weight:600; }
  .loc-actions span{
    margin-left:10px;
    cursor:pointer;
    opacity:.75;
  }
  .loc-actions span:hover{ opacity:1; }

  .version{
    color:#555;
    font-size:11px;
    text-align:center;
    margin-top:50px;
  }
</style>
</head>

<body>
<div class="c">

  <header>
    EV Charge Log Pro
  </header>

  <!-- FORM -->
  <div class="card">
    <div class="section">
      <input type="date" id="date">
    </div>

    <div class="section">
      <div class="row">
        <input type="text" inputmode="numeric" id="start" placeholder="Start %" maxlength="3">
        <input type="text" inputmode="numeric" id="end" placeholder="End %" maxlength="3">
      </div>
    </div>

    <div class="section">
      <select id="location">
        <option value="">Select Location</option>
        <option value="__ADD__">+ Add New Location</option>
        <option data-divider></option>
      </select>
    </div>

    <div class="section">
      <div class="quick-btns">
        <button class="qb" onclick="setRate(0.84)">0.84</button>
        <button class="qb" onclick="setRate(1.00)">1.00</button>
        <button class="qb" onclick="setRate(1.30)">1.30</button>
        <button class="qb" onclick="setRate(1.50)">1.50</button>
        <button class="qb" onclick="setRate(1.80)">1.80</button>
        <button class="qb" onclick="setRate(0)">Free</button>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <input type="number" step="0.001" id="rate" placeholder="Rate (RM/kWh)">
        <input type="number" step="0.01" id="cost" placeholder="Cost (RM)">
      </div>
    </div>

    <div class="section">
      <button class="btn" id="main-btn" onclick="submitForm()">Add Record</button>
      <button class="btn secondary" id="cancel-btn" onclick="cancelEdit()">Cancel Edit</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card">
    <div class="section" style="padding:0;">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Start</th>
              <th>End</th>
              <th>kWh</th>
              <th>Location</th>
              <th>Rate</th>
              <th>Cost</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- BACKUP -->
  <div class="card">
    <div class="section">
      <button class="btn secondary" onclick="document.getElementById('importFile').click()">Import CSV</button>
      <button class="btn" onclick="exportAll()">Export All Data</button>
      <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importAll(this)">
    </div>
  </div>

  <!-- LOCATION MANAGEMENT -->
  <div class="card">
    <div class="section">
      <div style="font-weight:600;margin-bottom:8px;">Saved Locations</div>
      <div id="loc-list"></div>
      <button class="btn secondary" style="margin-top:14px;" onclick="addLocationManually()">+ Add Location</button>
    </div>
  </div>

  <div class="version" id="version"></div>

</div>

<script>
const KEYS = {
  records:'evRecords2025',
  locations:'evLocations2025',
  rates:'evRateMemory2025'
};

let records = JSON.parse(localStorage.getItem(KEYS.records) || '[]');
let allLocations = JSON.parse(localStorage.getItem(KEYS.locations) || '["BH","PV","BAMBOO HILL","HOME","WORK"]');
let rateMemory = JSON.parse(localStorage.getItem(KEYS.rates) || '{}');
let editingIndex = null;

// ========= 日期默认今天 ===========
document.getElementById('date').value = new Date().toISOString().slice(0,10);

// ========= Start / End 输入逻辑 ===========
document.getElementById('start').oninput = function(){
  let v = this.value.replace(/[^0-9]/g,'');
  if(v.length>3) v = v.slice(0,3);
  if(v==="00") v="100";
  this.value = v;
  if(v.length >= 2) setTimeout(()=>document.getElementById('end').focus(),50);
};

document.getElementById('end').oninput = function(){
  let v = this.value.replace(/[^0-9]/g,'');
  if(v.length>3) v = v.slice(0,3);
  if(v==="00") v="100";
  this.value = v;
  if(v.length >= 2) setTimeout(()=>document.getElementById('location').focus(),50);
};

// ========= Location 下拉 ===========
function renderLocations(){
  const s = document.getElementById('location');
  s
