<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>EV Charge Log Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{--bg:#000;--card:#1c1c1e;--text:#fff;--tesla-red:#E31937;--gray:#333;--border:#2c2c2e;}
  .dark-mode{--bg:#000000;--card:#0d0d0d;--border:#1a1a1a;--gray:#222;}
  body{margin:0;font-family:-apple-system,sans-serif;background:var(--bg);color:var(--text);
       padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);transition:all 0.3s;}
  .c{max-width:600px;margin:0 auto;padding:0 16px;padding-bottom:120px;}
  header{padding:24px 0 16px;text-align:center;font-size:34px;font-weight:800;color:var(--tesla-red);position:relative;}
  .toggle{position:absolute;right:16px;top:20px;background:rgba(255,255,255,0.1);padding:6px 12px;border-radius:20px;font-size:13px;}
  .card{background:var(--card);border-radius:20px;overflow:hidden;margin:20px 0;box-shadow:0 4px 16px rgba(227,25,55,0.15);border:1px solid var(--border);}
  .section{padding:20px 20px 24px;}
  .section:not(:last-child){border-bottom:1px solid var(--border);}
  input,select{
    width:100%;padding:17px 16px;margin:8px 0;background:#2c2c2e;border:none;
    border-radius:13px;color:white;font-size:17px;box-sizing:border-box;
  }
  .row{display:flex;gap:12px;align-items:center;}
  .row > div{flex:1;}
  .btn{background:linear-gradient(180deg,#ff2a47,#e31937);color:white;border:none;padding:18px;border-radius:16px;font-size:19px;font-weight:700;margin-top:16px;box-shadow:0 6px 20px rgba(227,25,55,0.4);}
  .quick-btns{display:flex;flex-wrap:wrap;gap:11px;margin:14px 0 6px;justify-content:center;}
  .qb{padding:11px 18px;background:var(--gray);color:white;border-radius:30px;font-size:16px;font-weight:600;}
  .footer{text-align:center;color:#666;font-size:12px;margin:40px 0 20px;}
</style>
</head>
<body>

<div class="c">
  <header>
    EV Charge Log Pro
    <div class="toggle" onclick="toggleLang()">中</div>
    <div class="toggle" onclick="toggleDark()" style="right:68px;">黑</div>
  </header>

  <div class="card">
    <div class="section"><input type="date" id="date"></div>

    <div class="section">
      <div class="row">
        <input type="text" inputmode="numeric" id="start" placeholder="Start %" maxlength="2">
        <input type="text" inputmode="numeric" id="end" placeholder="End %" maxlength="3">
      </div>
    </div>

    <div class="section">
      <select id="location">
        <option value="">Select Location</option>
        <option value="__ADD__">+ Add New Location</option>
        <option disabled>────────────────</option>
      </select>
    </div>

    <div class="section">
      <div class="quick-btns">
        <button class="qb" onclick="setRate(0.84)">0.84</button>
        <button class="qb" onclick="setRate(1.00)">1.00</button>
        <button class="qb" onclick="setRate(1.30)">1.30</button>
        <button class="qb" onclick="setRate(1.50)">1.50</button>
        <button class="qb" onclick="setRate(1.80)">1.80</button>
        <button class="qb" onclick="setRate(0)">Free</button>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <input type="number" step="0.001" inputmode="decimal" id="rate" placeholder="Rate (RM/kWh)">
        <input type="number" step="0.01" inputmode="decimal" id="cost" placeholder="Cost (RM) 可不填">
      </div>
    </div>

    <div class="section">
      <button class="btn" onclick="addRecord()">Add Record</button>
    </div>
  </div>
</div>

<script>
const BATTERY_CAPACITY = 60;
const KEYS = {records:'evRecords2025',locations:'evLocations2025',rates:'evRateMemory2025',lang:'evLang2025',dark:'evDark2025'};

let records = JSON.parse(localStorage.getItem(KEYS.records)||'[]');
let allLocations = JSON.parse(localStorage.getItem(KEYS.locations)||'["BH","PV","BAMBOO HILL","HOME","WORK"]');
let rateMemory = JSON.parse(localStorage.getItem(KEYS.rates)||'{}');
let isCN = localStorage.getItem(KEYS.lang)==='cn';
let isUltraDark = localStorage.getItem(KEYS.dark)==='true';
if(isUltraDark)document.body.classList.add('dark-mode');
if(isCN)document.querySelector('.toggle').textContent='EN';

function toggleLang(){isCN=!isCN;localStorage.setItem(KEYS.lang,isCN?'cn':'en');location.reload();}
function toggleDark(){isUltraDark=!isUltraDark;localStorage.setItem(KEYS.dark,isUltraDark);document.body.classList.toggle('dark-mode',isUltraDark);}

// Start %：两位数立刻跳（不可能 100% 开始充）
document.getElementById('start').oninput = function() {
  let val = this.value.replace(/[^0-9]/g,'');
  if(val.length > 2) val = val.slice(0,2);
  this.value = val;
  if(val.length === 2) {
    setTimeout(() => document.getElementById('end').focus(), 50);
  }
};

// End %：三位数才跳（支持 099、100）
document.getElementById('end').oninput = function() {
  let val = this.value.replace(/[^0-9]/g,'');
  if(val.length > 3) val = val.slice(0,3);
  this.value = val;
  const num = parseInt(val||'0');
  if(val.length === 3 || num === 100) {
    setTimeout(() => document.getElementById('location').focus(), 50);
  }
};

// 地点管理（长按编辑/删除）
function renderLocations(){
  const s=document.getElementById('location');
  s.innerHTML=`<option value="">Select Location</option><option value="__ADD__">+ Add New Location</option><option disabled>────────────────</option>`;
  allLocations.sort().forEach(l=>{const o=document.createElement('option');o.value=l;o.textContent=l;s.appendChild(o);});
}
let longPressTimer;
document.getElementById('location').addEventListener('pointerdown',e=>{
  if(!e.target.value||e.target.value.startsWith('__'))return;
  const loc=e.target.value;
  longPressTimer=setTimeout(()=>{
    const nn=prompt(`Edit (blank=delete)\nCurrent: ${loc}`,loc);
    if(nn===null)return;
    if(nn.trim()===""){
      if(confirm(`Delete ${loc}?`)){
        allLocations=allLocations.filter(x=>x!==loc);
        delete rateMemory[loc];
        localStorage.setItem(KEYS.locations,JSON.stringify(allLocations));
        localStorage.setItem(KEYS.rates,JSON.stringify(rateMemory));
        renderLocations();
      }
    }else{
      const newName=nn.trim().toUpperCase();
      if(newName&&!allLocations.includes(newName)){
        const i=allLocations.indexOf(loc);
        allLocations[i]=newName;
        if(rateMemory[loc]){rateMemory[newName]=rateMemory[loc];delete rateMemory[loc];}
        localStorage.setItem(KEYS.locations,JSON.stringify(allLocations));
        localStorage.setItem(KEYS.rates,JSON.stringify(rateMemory));
        renderLocations();
        document.getElementById('location').value=newName;
        autoFillRate();
      }
    }
  },800);
});
['pointerup','pointercancel','pointerleave'].forEach(ev=>document.getElementById('location').addEventListener(ev,()=>clearTimeout(longPressTimer)));

document.getElementById('location').onchange=function(){
  if(this.value==="__ADD__"){
    const n=prompt("New location")?.trim().toUpperCase();
    if(n&&!allLocations.includes(n)){allLocations.push(n);localStorage.setItem(KEYS.locations,JSON.stringify(allLocations));renderLocations();this.value=n;autoFillRate();}
    else this.value="";
  }else autoFillRate();
};

function autoFillRate(){
  const loc=document.getElementById('location').value;
  if(loc&&rateMemory[loc])document.getElementById('rate').value=rateMemory[loc];
}
function setRate(v){document.getElementById('rate').value=v;}

function addRecord(){
  const loc=document.getElementById('location').value;
  if(!loc)return alert("Select location");
  const start=parseInt(document.getElementById('start').value||0);
  const end=parseInt(document.getElementById('end').value||0);
  if(isNaN(start)||isNaN(end)||start>=end)return alert("Check start & end %");
  const rate=document.getElementById('rate').value?parseFloat(document.getElementById('rate').value):null;
  const manualCost=document.getElementById('cost').value?parseFloat(document.getElementById('cost').value):null;
  const kwh=((end-start)/100*BATTERY_CAPACITY).toFixed(2);
  const cost=manualCost!==null?manualCost:(rate?(kwh*rate).toFixed(2):null);
  if(rate){rateMemory[loc]=rate;localStorage.setItem(KEYS.rates,JSON.stringify(rateMemory));}
  records.push({date:document.getElementById('date').value,start,end,kwh:parseFloat(kwh),location:loc,rate,cost:cost?parseFloat(cost):null,id:Date.now()});
  localStorage.setItem(KEYS.records,JSON.stringify(records));
  document.getElementById('start').value=document.getElementById('end').value=document.getElementById('rate').value=document.getElementById('cost').value='';
  document.getElementById('start').focus();
}

// 初始化
document.getElementById('date').value=new Date().toISOString().slice(0,10);
renderLocations();
document.getElementById('start').focus();
</script>
</body>
</html>
