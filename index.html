<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>EV Charge Log Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --bg:#000;
    --card:#1c1c1e;
    --text:#fff;
    --tesla-red:#E31937;
    --gray:#333;
    --border:#2c2c2e;
    --focus:#007AFF;
  }

  body{
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    background:var(--bg);
    color:var(--text);
    padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    transition:all .25s;
  }

  .c{
    max-width:600px;
    margin:0 auto;
    padding:0 16px 120px;
  }

  /* HEADER */
  header{
    padding:32px 0 20px;
    text-align:center;
    font-size:34px;
    font-weight:800;
    color:var(--tesla-red);
    position:relative;
  }

  /* Â∑¶‰∏äËØ≠Ë®ÄÂàáÊç¢ */
  .toggle{
    position:absolute;
    left:16px;
    top:32px;
    background:rgba(255,255,255,0.15);
    padding:6px 14px;
    border-radius:20px;
    font-size:13px;
    cursor:pointer;
    backdrop-filter: blur(6px);
  }

  /* Âè≥‰∏ä Tesla logo */
  .logo{
    position:absolute;
    right:12px;
    top:24px;
    width:40px;
    opacity:.85;
  }

  /* Âç°Áâá */
  .card{
    background:var(--card);
    border-radius:22px;
    overflow:hidden;
    margin:22px 0;
    border:1px solid var(--border);
    box-shadow:0 8px 32px rgba(227,25,55,0.12);
  }

  .section{
    padding:22px 20px 26px;
  }
  .section:not(:last-child){
    border-bottom:1px solid var(--border);
  }

  /* Input / Select */
  input, select{
    width:100%;
    padding:18px;
    margin:10px 0;
    border:none;
    border-radius:16px;
    background:#2c2c2e;
    color:white;
    font-size:18px;
    transition:.2s;
  }
  input:focus, select:focus{
    background:#3a3a3c;
    outline:none;
    box-shadow:0 0 0 3px var(--focus);
  }

  /* Location ‰∏ãÊãâÁÆ≠Â§¥ */
  #location{
    font-size:19px;
    font-weight:600;
    padding:20px 18px;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 18px center;
  }
  #location option[data-divider]{
    height:1px;
    background:#444;
    margin:8px 16px;
    pointer-events:none;
  }

  .row{
    display:flex;
    gap:14px;
  }
  .row > input { flex:1; }

  /* Rate Âø´Êç∑ÊåâÈíÆ */
  .quick-btns{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    justify-content:center;
  }
  .qb{
    padding:12px 22px;
    background:var(--gray);
    border-radius:40px;
    color:white;
    font-size:17px;
    font-weight:600;
    border:1px solid #555;
    cursor:pointer;
  }

  /* ‰∏ªÊåâÈíÆ */
  .btn{
    width:100%;
    background:linear-gradient(180deg,#ff2a47,#e31937);
    color:white;
    border:none;
    padding:20px;
    border-radius:18px;
    font-size:20px;
    font-weight:700;
    margin-top:18px;
    cursor:pointer;
    box-shadow:0 8px 30px rgba(227,25,55,0.45);
  }
  .btn.secondary{
    background:#333;
    padding:16px;
    font-size:16px;
    box-shadow:none;
    display:none;
  }

  /* Ë°®Ê†º */
  .table-wrapper{
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    border-radius:16px;
    margin:8px 0;
  }
  table{
    width:100%;
    min-width:720px;
    border-collapse:separate;
    border-spacing:0;
  }
  th,td{
    padding:16px 10px;
    text-align:center;
    border-bottom:1px solid var(--border);
    border-right:1px solid var(--border);
    font-size:15px;
  }
  th:last-child,td:last-child{
    border-right:none;
  }
  th{
    background:#252525;
    color:#aaa;
    font-weight:600;
  }
  tr:last-child td{
    border-bottom:none;
  }
  .empty-row{
    text-align:center;
    padding:16px;
    color:#777;
    font-size:14px;
  }

  .action{
    font-size:18px;
    cursor:pointer;
    opacity:0.7;
    margin:0 4px;
  }
  .action:hover{ opacity:1; }

  /* Location ÁÆ°ÁêÜÂàóË°® */
  .loc-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px 0;
    border-bottom:1px solid var(--border);
    font-size:15px;
  }
  .loc-row:last-child{
    border-bottom:none;
  }
  .loc-name{
    font-weight:600;
    letter-spacing:0.3px;
  }
  .loc-actions span{
    margin-left:10px;
    cursor:pointer;
    opacity:.75;
    font-size:16px;
  }
  .loc-actions span:hover{ opacity:1; }

  .version{
    color:#555;
    font-size:11px;
    text-align:center;
    margin-top:50px;
  }
</style>
</head>

<body>
<div class="c">

  <header>
    <span id="title-text">EV Charge Log Pro</span>
    <div class="toggle" onclick="toggleLang()" id="lang-toggle">‰∏≠</div>
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e8/Tesla_logo.png" class="logo">
  </header>

  <!-- ËæìÂÖ•Âç°Áâá -->
  <div class="card">
    <!-- Êó•Êúü -->
    <div class="section">
      <input type="date" id="date">
    </div>

    <!-- Start / End -->
    <div class="section">
      <div class="row">
        <input type="text" inputmode="numeric" id="start" placeholder="Start %" maxlength="3">
        <input type="text" inputmode="numeric" id="end" placeholder="End %" maxlength="3">
      </div>
    </div>

    <!-- Location -->
    <div class="section">
      <select id="location">
        <option value="">Select Location</option>
        <option value="__ADD__">+ Add New Location</option>
        <option data-divider></option>
      </select>
    </div>

    <!-- Rate Âø´ÈÄüÈÄâÊã© -->
    <div class="section">
      <div class="quick-btns">
        <button class="qb" onclick="setRate(0.84)">0.84</button>
        <button class="qb" onclick="setRate(1.00)">1.00</button>
        <button class="qb" onclick="setRate(1.30)">1.30</button>
        <button class="qb" onclick="setRate(1.50)">1.50</button>
        <button class="qb" onclick="setRate(1.80)">1.80</button>
        <button class="qb" onclick="setRate(0)">Free</button>
      </div>
    </div>

    <!-- Rate / Cost -->
    <div class="section">
      <div class="row">
        <input type="number" step="0.001" id="rate" placeholder="Rate (RM/kWh)">
        <input type="number" step="0.01" id="cost" placeholder="Cost (RM)">
      </div>
    </div>

    <!-- ‰∏ªÊåâÈíÆ -->
    <div class="section">
      <button class="btn" id="main-btn" onclick="submitForm()">Add Record</button>
      <button class="btn secondary" id="cancel-btn" onclick="cancelEdit()">Cancel Edit</button>
    </div>
  </div>

  <!-- ËÆ∞ÂΩïË°® -->
  <div class="card">
    <div class="section" style="padding:0;">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th id="th-date">Date</th>
              <th id="th-start">Start</th>
              <th id="th-end">End</th>
              <th id="th-kwh">kWh</th>
              <th id="th-loc">Location</th>
              <th id="th-rate">Rate</th>
              <th id="th-cost">Cost</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Backup Âå∫Âüü -->
  <div class="card">
    <div class="section">
      <button class="btn secondary" onclick="document.getElementById('importFile').click()" id="import-btn">Import CSV</button>
      <button class="btn" onclick="exportAll()" id="export-btn">Export All Data</button>
      <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importAll(this)">
    </div>
  </div>

  <!-- Location ÁÆ°ÁêÜ -->
  <div class="card">
    <div class="section">
      <div style="font-weight:600;margin-bottom:8px;" id="loc-manage-title">Saved Locations</div>
      <div id="loc-list"></div>
      <button class="btn secondary" style="margin-top:14px;" onclick="addLocationManually()" id="loc-add-btn">+ Add Location</button>
    </div>
  </div>

  <div class="version" id="version"></div>

</div>

<script>
const KEYS = {
  records:'evRecords2025',
  locations:'evLocations2025',
  rates:'evRateMemory2025',
  lang:'evLang2025'
};

let records = JSON.parse(localStorage.getItem(KEYS.records) || '[]');
let allLocations = JSON.parse(localStorage.getItem(KEYS.locations) || '["BH","PV","BAMBOO HILL","HOME","WORK"]');
let rateMemory = JSON.parse(localStorage.getItem(KEYS.rates) || '{}');
let isCN = localStorage.getItem(KEYS.lang) === 'cn';
let editingIndex = null;

// =========== ËØ≠Ë®Ä ===========
function toggleLang(){
  isCN = !isCN;
  localStorage.setItem(KEYS.lang, isCN ? 'cn' : 'en');
  applyLang();
  renderLocations();
  renderLocationList();
  renderTable();
}

function applyLang(){
  const title = document.getElementById('title-text');
  const langToggle = document.getElementById('lang-toggle');
  const start = document.getElementById('start');
  const end   = document.getElementById('end');
  const rate  = document.getElementById('rate');
  const cost  = document.getElementById('cost');
  const mainBtn = document.getElementById('main-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const importBtn = document.getElementById('import-btn');
  const exportBtn = document.getElementById('export-btn');
  const thDate  = document.getElementById('th-date');
  const thStart = document.getElementById('th-start');
  const thEnd   = document.getElementById('th-end');
  const thKwh   = document.getElementById('th-kwh');
  const thLoc   = document.getElementById('th-loc');
  const thRate  = document.getElementById('th-rate');
  const thCost  = document.getElementById('th-cost');
  const locSelect = document.getElementById('location');
  const locTitle = document.getElementById('loc-manage-title');
  const locAddBtn = document.getElementById('loc-add-btn');

  if(isCN){
    title.textContent = 'ÂÖÖÁîµËÆ∞ÂΩï Pro';
    langToggle.textContent = 'EN';
    start.placeholder = 'Ëµ∑Âßã %';
    end.placeholder   = 'ÁªìÊùü %';
    rate.placeholder  = 'Âçï‰ª∑ (RM/kWh)';
    cost.placeholder  = 'Ë¥πÁî® (RM)';
    mainBtn.textContent = editingIndex === null ? 'Êñ∞Â¢ûËÆ∞ÂΩï' : '‰øùÂ≠ò‰øÆÊîπ';
    cancelBtn.textContent = 'ÂèñÊ∂àÁºñËæë';
    importBtn.textContent = 'ÂØºÂÖ• CSV';
    exportBtn.textContent = 'ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ';
    thDate.textContent  = 'Êó•Êúü';
    thStart.textContent = 'Ëµ∑Âßã';
    thEnd.textContent   = 'ÁªìÊùü';
    thKwh.textContent   = 'kWh';
    thLoc.textContent   = 'Âú∞ÁÇπ';
    thRate.textContent  = 'Âçï‰ª∑';
    thCost.textContent  = 'Ë¥πÁî®';
    if(locSelect.options[0]) locSelect.options[0].textContent = 'ÈÄâÊã©Âú∞ÁÇπ';
    if(locSelect.options[1]) locSelect.options[1].textContent = '+ Êñ∞Â¢ûÂú∞ÁÇπ';
    locTitle.textContent = '‰øùÂ≠òÁöÑÂú∞ÁÇπ';
    locAddBtn.textContent = '+ Êñ∞Â¢ûÂú∞ÁÇπ';
  }else{
    title.textContent = 'EV Charge Log Pro';
    langToggle.textContent = '‰∏≠';
    start.placeholder = 'Start %';
    end.placeholder   = 'End %';
    rate.placeholder  = 'Rate (RM/kWh)';
    cost.placeholder  = 'Cost (RM)';
    mainBtn.textContent = editingIndex === null ? 'Add Record' : 'Save Changes';
    cancelBtn.textContent = 'Cancel Edit';
    importBtn.textContent = 'Import CSV';
    exportBtn.textContent = 'Export All Data';
    thDate.textContent  = 'Date';
    thStart.textContent = 'Start';
    thEnd.textContent   = 'End';
    thKwh.textContent   = 'kWh';
    thLoc.textContent   = 'Location';
    thRate.textContent  = 'Rate';
    thCost.textContent  = 'Cost';
    if(locSelect.options[0]) locSelect.options[0].textContent = 'Select Location';
    if(locSelect.options[1]) locSelect.options[1].textContent = '+ Add New Location';
    locTitle.textContent = 'Saved Locations';
    locAddBtn.textContent = '+ Add Location';
  }
}

// =========== Êó•Êúü / ËæìÂÖ• ===========
document.getElementById('date').value = new Date().toISOString().slice(0,10);

document.getElementById('start').oninput = function(){
  let v = this.value.replace(/[^0-9]/g,'');
  if(v.length>3) v = v.slice(0,3);
  if(v === '00') v = '100';
  this.value = v;
  if(v.length >= 2) setTimeout(()=>document.getElementById('end').focus(),50);
};

document.getElementById('end').oninput = function(){
  let v = this.value.replace(/[^0-9]/g,'');
  if(v.length>3) v = v.slice(0,3);
  if(v === '00') v = '100';
  this.value = v;
  if(v.length >= 2) setTimeout(()=>document.getElementById('location').focus(),50);
};

function setRate(v){
  const rate = document.getElementById('rate');
  if(v === 0){
    rate.value = '';
    rate.placeholder = isCN ? 'ÂÖçË¥π / Free' : 'Free / 0';
  }else{
    rate.value = v;
    document.getElementById('cost').focus();
  }
}

// =========== Location ‰∏ãÊãâ ===========
function renderLocations(){
  const s = document.getElementById('location');
  s.innerHTML = '';

  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = isCN ? 'ÈÄâÊã©Âú∞ÁÇπ' : 'Select Location';
  s.appendChild(opt0);

  const optAdd = document.createElement('option');
  optAdd.value = '__ADD__';
  optAdd.textContent = isCN ? '+ Êñ∞Â¢ûÂú∞ÁÇπ' : '+ Add New Location';
  s.appendChild(optAdd);

  const divider = document.createElement('option');
  divider.setAttribute('data-divider','');
  s.appendChild(divider);

  allLocations.sort().forEach(l=>{
    const o = document.createElement('option');
    o.value = l;
    o.textContent = l;
    s.appendChild(o);
  });
}

document.getElementById('location').addEventListener('change', function(){
  const v = this.value;
  if(v === '__ADD__'){
    addLocationManually();
  }else if(v){
    if(rateMemory[v] != null){
      document.getElementById('rate').value = rateMemory[v];
    }
  }
});

// =========== Location ÁÆ°ÁêÜ ===========

function addLocationManually(){
  const msg = isCN ? 'ËæìÂÖ•Êñ∞Âú∞ÁÇπÂêçÁß∞Ôºà‰æãÂ¶ÇÔºöBHÔºâ' : 'Enter new location (e.g. BH)';
  const name = prompt(msg);
  if(!name) return;
  const up = name.trim().toUpperCase();
  if(!up) return;
  if(!allLocations.includes(up)){
    allLocations.push(up);
    saveAll();
  }
  renderLocations();
  renderLocationList();
}

function editLocationName(oldName){
  const msg = isCN ? '‰øÆÊîπÂú∞ÁÇπÂêçÁß∞' : 'Edit location name';
  const name = prompt(msg, oldName);
  if(!name) return;
  const up = name.trim().toUpperCase();
  if(!up || up === oldName) return;

  const idx = allLocations.indexOf(oldName);
  if(idx >= 0) allLocations[idx] = up;

  records.forEach(r=>{
    if((r.location || '').toUpperCase() === oldName){
      r.location = up;
    }
  });

  if(rateMemory[oldName] != null){
    rateMemory[up] = rateMemory[oldName];
    delete rateMemory[oldName];
  }

  saveAll();
  renderLocations();
  renderLocationList();
  renderTable();
}

function deleteLocationName(name){
  const msg = isCN ? 'Âè™‰ºöÂà†Èô§‰∏ãÊãâÈÄâÈ°πÔºå‰∏ç‰ºöÂà†Èô§ÊóßËÆ∞ÂΩï„ÄÇ\nÁ°ÆÂÆöË¶ÅÁßªÈô§Ê≠§Âú∞ÁÇπÔºü' :
                     'This removes the location from dropdown only.\nExisting records stay.\nDelete?';
  if(!confirm(msg)) return;

  allLocations = allLocations.filter(l => l !== name);
  if(rateMemory[name] != null) delete rateMemory[name];

  saveAll();
  renderLocations();
  renderLocationList();
}

function renderLocationList(){
  const box = document.getElementById('loc-list');
  box.innerHTML = '';
  if(!allLocations.length){
    const div = document.createElement('div');
    div.className = 'empty-row';
    div.textContent = isCN ? 'ÊöÇÊó†Ëá™ÂÆö‰πâÂú∞ÁÇπ' : 'No saved locations yet';
    box.appendChild(div);
    return;
  }

  const list = [...allLocations].sort();
  list.forEach(loc=>{
    const row = document.createElement('div');
    row.className = 'loc-row';
    const name = document.createElement('div');
    name.className = 'loc-name';
    name.textContent = loc;
    const actions = document.createElement('div');
    actions.className = 'loc-actions';

    const edit = document.createElement('span');
    edit.textContent = '‚úèÔ∏è';
    edit.title = isCN ? 'ÊîπÂêç' : 'Rename';
    edit.onclick = ()=>editLocationName(loc);

    const del = document.createElement('span');
    del.textContent = 'üóë';
    del.title = isCN ? 'Âà†Èô§ÈÄâÈ°π' : 'Remove option';
    del.onclick = ()=>deleteLocationName(loc);

    actions.appendChild(edit);
    actions.appendChild(del);
    row.appendChild(name);
    row.appendChild(actions);
    box.appendChild(row);
  });
}

// =========== Â∑•ÂÖ∑ ===========
function formatDateDisplay(str){
  if(!str) return '';
  const d = new Date(str);
  if(isNaN(d)) return str;
  const day = d.getDate();
  const m   = d.getMonth()+1;
  const y   = d.getFullYear();
  return `${day}/${m}/${y}`;
}

function saveAll(){
  localStorage.setItem(KEYS.records, JSON.stringify(records));
  localStorage.setItem(KEYS.locations, JSON.stringify(allLocations));
  localStorage.setItem(KEYS.rates, JSON.stringify(rateMemory));
}

// =========== Ë°®Ê†º ===========
function renderTable(){
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  if(!records.length){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 8;
    td.className = 'empty-row';
    td.textContent = isCN ? 'ÁõÆÂâçËøòÊ≤°ÊúâËÆ∞ÂΩï' : 'No records yet';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  const sorted = records
    .map((r,i)=>({...r, _i:i}))
    .sort((a,b)=> (a.date || '').localeCompare(b.date || ''));

  sorted.forEach(r=>{
    const tr = document.createElement('tr');
    const kwh = (r.rate && r.cost) ? (r.cost / r.rate) : 0;

    tr.innerHTML = `
      <td>${formatDateDisplay(r.date)}</td>
      <td>${r.start ?? ''}</td>
      <td>${r.end ?? ''}</td>
      <td>${kwh ? kwh.toFixed(2) : ''}</td>
      <td>${r.location || ''}</td>
      <td>${r.rate ? r.rate.toFixed(3).replace(/0+$/,'').replace(/\.$/,'') : ''}</td>
      <td>${r.cost ? r.cost.toFixed(2) : ''}</td>
      <td></td>
    `;

    const tdAct = tr.lastElementChild;
    const edit = document.createElement('span');
    edit.className = 'action';
    edit.textContent = '‚úèÔ∏è';
    edit.title = isCN ? 'ÁºñËæë' : 'Edit';
    edit.onclick = ()=>startEdit(r._i);

    const del = document.createElement('span');
    del.className = 'action';
    del.textContent = 'üóë';
    del.title = isCN ? 'Âà†Èô§' : 'Delete';
    del.onclick = ()=>deleteRecord(r._i);

    tdAct.appendChild(edit);
    tdAct.appendChild(del);
    tbody.appendChild(tr);
  });
}

// =========== ÁºñËæë / Âà†Èô§ËÆ∞ÂΩï ===========
function startEdit(i){
  const r = records[i];
  editingIndex = i;

  document.getElementById('date').value = r.date || '';
  document.getElementById('start').value = r.start ?? '';
  document.getElementById('end').value   = r.end ?? '';
  document.getElementById('rate').value  = r.rate ?? '';
  document.getElementById('cost').value  = r.cost ?? '';

  renderLocations();
  document.getElementById('location').value = r.location || '';

  document.getElementById('main-btn').textContent = isCN ? '‰øùÂ≠ò‰øÆÊîπ' : 'Save Changes';
  document.getElementById('cancel-btn').style.display = 'block';
}

function cancelEdit(){
  editingIndex = null;
  document.getElementById('main-btn').textContent = isCN ? 'Êñ∞Â¢ûËÆ∞ÂΩï' : 'Add Record';
  document.getElementById('cancel-btn').style.display = 'none';

  document.getElementById('date').value = new Date().toISOString().slice(0,10);
  document.getElementById('start').value = '';
  document.getElementById('end').value = '';
  document.getElementById('location').value = '';
  document.getElementById('rate').value = '';
  document.getElementById('cost').value = '';
}

function deleteRecord(i){
  if(!confirm(isCN ? 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÔºü' : 'Delete this record?')) return;
  records.splice(i,1);
  saveAll();
  cancelEdit();
  renderTable();
}

// =========== Êèê‰∫§ËÆ∞ÂΩï ===========
function submitForm(){
  const date = document.getElementById('date').value;
  const start = Number(document.getElementById('start').value || 0);
  const end   = Number(document.getElementById('end').value || 0);
  const loc   = (document.getElementById('location').value || '').trim().toUpperCase();
  const rate  = Number(document.getElementById('rate').value || 0);
  const cost  = Number(document.getElementById('cost').value || 0);

  if(!date || !loc || !rate || !cost){
    alert(isCN ? 'Êó•Êúü / Âú∞ÁÇπ / Âçï‰ª∑ / Ë¥πÁî® ‰∏çËÉΩ‰∏∫Á©∫' : 'Date / Location / Rate / Cost are required');
    return;
  }

  const rec = {date, start, end, location:loc, rate, cost};

  if(loc){
    rateMemory[loc] = rate;
  }

  if(editingIndex === null){
    records.push(rec);
  }else{
    records[editingIndex] = rec;
  }

  saveAll();
  cancelEdit();
  renderTable();
  renderLocationList();
  document.getElementById('start').focus();
}

// =========== Export CSV ===========
function exportAll(){
  if(!records.length){
    alert(isCN ? 'ÊöÇÊó†ËÆ∞ÂΩïÂèØÂØºÂá∫' : 'No data to export.');
    return;
  }
  const lines = ['date,start,end,location,rate,cost'];
  records.forEach(r=>{
    const loc = (r.location || '').replace(/"/g,'""');
    const line = `${r.date || ''},${r.start ?? ''},${r.end ?? ''},"${loc}",${r.rate ?? ''},${r.cost ?? ''}`;
    lines.push(line);
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const now = new Date();
  const stamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
  a.href = url;
  a.download = `ev_charge_log_${stamp}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// =========== Import CSV ===========
function parseCSV(text){
  const rows = text.split(/\r?\n/).filter(l=>l.trim());
  if(!rows.length) return [];

  const splitRow = (row)=>{
    const result = [];
    let cur = '';
    let inQ = false;
    for(let i=0;i<row.length;i++){
      const c = row[i];
      if(c === '"'){ inQ = !inQ; continue; }
      if(c === ',' && !inQ){
        result.push(cur);
        cur = '';
      }else{
        cur += c;
      }
    }
    result.push(cur);
    return result.map(s=>s.trim());
  };

  const header = splitRow(rows[0]);
  const hasHeader = header.some(h=>/date/i.test(h));
  const startIndex = hasHeader ? 1 : 0;

  let map;
  if(hasHeader){
    const hmap = {};
    header.forEach((h,i)=>{ hmap[h.toLowerCase()] = i; });
    map = {
      date: hmap['date'],
      start: hmap['start'],
      end: hmap['end'],
      location: hmap['location'],
      rate: hmap['rate'],
      cost: hmap['cost']
    };
  }else{
    map = {date:0,start:1,end:2,location:3,rate:4,cost:5};
  }

  const out=[];
  for(let i=startIndex;i<rows.length;i++){
    const cols = splitRow(rows[i]);
    if(!cols.length) continue;
    const get = idx => (idx!=null && cols[idx]!=null ? cols[idx] : '').trim();
    const date = get(map.date);
    const rate = Number(get(map.rate) || 0);
    const cost = Number(get(map.cost) || 0);
    const start = Number(get(map.start) || 0);
    const end   = Number(get(map.end) || 0);
    const loc   = get(map.location).replace(/""/g,'"').toUpperCase();

    if(!date && !loc && !rate && !cost) continue;
    out.push({date, start, end, location:loc, rate, cost});
  }
  return out;
}

function importAll(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const text = e.target.result || '';
    const parsed = parseCSV(text);
    if(!parsed.length){
      alert(isCN ? 'CSV ‰∏≠Ê≤°ÊúâÂèØÁî®Êï∞ÊçÆ' : 'No valid data in CSV.');
      return;
    }
    const replace = confirm(
      (isCN ? 'Ëß£ÊûêÂà∞ ' : 'Parsed ') +
      parsed.length +
      (isCN ? ' Êù°ËÆ∞ÂΩï„ÄÇ\n\nÁ°ÆÂÆöË¶ÜÁõñÂΩìÂâçÊï∞ÊçÆÔºü\n„ÄåÁ°ÆÂÆö„Äç=Ë¶ÜÁõñ\n„ÄåÂèñÊ∂à„Äç=ËøΩÂä†' :
              ' records.\n\nOK = REPLACE\nCancel = APPEND')
    );
    if(replace){
      records = parsed;
    }else{
      records = records.concat(parsed);
    }

    // ÂØºÂÖ•ÂêéËá™Âä®Ê†πÊçÆ records ÁîüÊàêÂú∞ÁÇπÂàóË°®
    const locSet = new Set(allLocations);
    records.forEach(r=>{
      if(r.location) locSet.add(r.location.toUpperCase());
    });
    allLocations = Array.from(locSet);

    saveAll();
    cancelEdit();
    renderTable();
    renderLocations();
    renderLocationList();
  };
  reader.readAsText(file);
}

// =========== ÁâàÊú¨Âè∑ ===========
function updateVersion(){
  const d=new Date();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  const h=String(d.getHours()).padStart(2,'0');
  const min=String(d.getMinutes()).padStart(2,'0');
  document.getElementById('version').textContent=`Version ${m}${day}-${h}${min}`;
}

// =========== ÂàùÂßãÂåñ ===========
renderLocations();
applyLang();
renderTable();
renderLocationList();
updateVersion();
document.getElementById('start').focus();
</script>
</body>
</html>
