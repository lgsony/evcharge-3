<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <title>EV Charge Log Pro v5 – 小帅专用</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #000000;
      --card: #151515;
      --card-soft: #1c1c1c;
      --border: #333333;
      --border-soft: #2a2a2a;
      --text: #ffffff;
      --text-soft: #b3b3b3;
      --accent: #ffffff;
      --accent-soft: #f5f5f5;
      --danger: #ff4b5c;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.7);
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        -segoe-ui, Roboto, sans-serif;
      background: radial-gradient(circle at top, #101010 0, #000 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 16px 80px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 12px;
      padding: 4px 4px 8px;
    }

    header .title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    header .subtitle {
      font-size: 11px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    header .badge {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      font-size: 10px;
      color: var(--text-soft);
    }

    .card {
      background: linear-gradient(135deg, #151515, #101010);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 10px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .pill {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 3px 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field label {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field label span.right {
      font-size: 10px;
      opacity: 0.6;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 8px 9px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: #050505;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .field input:focus,
    .field select:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08);
      background: #0a0a0a;
    }

    .field input::placeholder {
      color: #555;
    }

    .field-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      background: #050505;
      color: var(--text-soft);
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
      transition: background 0.12s ease, transform 0.06s ease, border 0.12s ease;
      white-space: nowrap;
    }

    .btn span.icon {
      font-size: 14px;
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
      border-color: #f5f5f5;
    }

    .btn-primary:active {
      transform: scale(0.98);
      background: #f0f0f0;
    }

    .btn-soft {
      background: #101010;
    }

    .btn-soft:active {
      transform: scale(0.98);
      background: #181818;
    }

    .btn-danger {
      border-color: rgba(255, 75, 92, 0.4);
      color: #ff9aa4;
    }

    .btn-sm {
      padding: 4px 9px;
      font-size: 11px;
      border-radius: 999px;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
    }

    .pill-info {
      font-size: 11px;
      color: var(--text-soft);
      opacity: 0.9;
      margin-top: 4px;
    }

    .pill-info strong {
      color: var(--accent-soft);
      font-weight: 500;
    }

    /* Records table */
    .records-card {
      padding-top: 10px;
    }

    .table-wrapper {
      max-height: 340px;
      overflow: auto;
      margin: 0 -4px;
      padding: 0 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 700px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #101010;
    }

    th,
    td {
      padding: 6px 4px;
      text-align: right;
      border-bottom: 1px solid #151515;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--text-soft);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    tbody tr {
      background: transparent;
      transition: background 0.12s ease;
    }

    tbody tr:nth-child(2n) {
      background: rgba(255, 255, 255, 0.01);
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    td .badge-loc {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 10px;
      color: var(--text-soft);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    td .action-row {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
    }

    td .action-row button {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #050505;
      color: var(--text-soft);
      cursor: pointer;
      transition: background 0.12s ease, transform 0.06s ease;
    }

    td .action-row button:hover {
      background: #111;
    }

    td .action-row button:active {
      transform: scale(0.97);
    }

    td .action-row .delete {
      border-color: rgba(255, 75, 92, 0.35);
      color: #ff9aa4;
    }

    .empty-state {
      text-align: center;
      padding: 22px 6px 16px;
      font-size: 12px;
      color: var(--text-soft);
    }

    /* Monthly summary */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 8px;
    }

    .summary-card {
      background: radial-gradient(circle at top left, #1f1f1f, #101010);
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .summary-month {
      font-size: 12px;
      font-weight: 500;
    }

    .summary-kpi {
      font-size: 10px;
      color: var(--text-soft);
    }

    .summary-kpi strong {
      color: var(--accent-soft);
      font-weight: 500;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-soft);
    }

    .summary-row span.value {
      color: var(--accent-soft);
    }

    /* Bottom bar */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.94);
      border-top: 1px solid var(--border);
      padding: 8px 12px 10px;
      display: flex;
      justify-content: center;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .bottom-inner {
      max-width: 960px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .bottom-group {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .bottom-hint {
      font-size: 10px;
      color: var(--text-soft);
    }

    input[type="file"] {
      display: none;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      color: var(--text-soft);
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 20;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(4px);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: #111;
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 12px;
      width: 100%;
      max-width: 360px;
      box-shadow: var(--shadow-soft);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .modal-body {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .radio-row {
      display: flex;
      gap: 10px;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .radio-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    /* Small label chip */
    .tiny-chip {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #222;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <!-- Import Mode Modal -->
  <div class="modal-backdrop" id="importModal">
    <div class="modal">
      <div class="modal-title">Import CSV</div>
      <div class="modal-body">
        选择导入方式：
      </div>
      <div class="radio-row">
        <label>
          <input type="radio" name="importMode" value="append" checked />
          追加 (Append)
        </label>
        <label>
          <input type="radio" name="importMode" value="replace" />
          覆盖 (Replace)
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn btn-sm btn-soft" id="importCancelBtn">取消</button>
        <button class="btn btn-sm btn-primary" id="importConfirmBtn">选择文件</button>
      </div>
      <input type="file" id="fileInput" accept=".csv,text/csv" />
    </div>
  </div>

  <div class="app">
    <header>
      <div>
        <div class="subtitle">EV CHARGE LOG PRO</div>
        <div class="title">小帅 · Tesla 充电记录</div>
      </div>
      <div class="badge">
        Battery 60 kWh · v5
      </div>
    </header>

    <!-- Form Card -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">New Session</div>
        <div class="pill">基于上一条记录自动计算</div>
      </div>
      <div class="form-grid">
        <div class="field">
          <label for="dateInput">Date</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="field">
          <label for="startPercent">
            Start %
            <span class="right">2位自动跳</span>
          </label>
          <input
            id="startPercent"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="2"
            placeholder="20"
          />
        </div>
        <div class="field">
          <label for="endPercent">
            End %
            <span class="right">2位自动跳</span>
          </label>
          <input
            id="endPercent"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="2"
            placeholder="80"
          />
        </div>
        <div class="field">
          <label for="odoInput">ODO km</label>
          <input
            id="odoInput"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            placeholder="例如 12850"
          />
        </div>
        <div class="field">
          <label for="locationSelect">
            Location
            <span class="right tiny-chip" id="locationCount">0 saved</span>
          </label>
          <select id="locationSelect">
            <option value="">选择或输入下方自定义</option>
          </select>
        </div>
        <div class="field">
          <label for="locationCustom">Add / Edit Location</label>
          <input
            id="locationCustom"
            type="text"
            placeholder="例如 Sunway SC, Home, Gentari..."
          />
        </div>
        <div class="field">
          <label for="rateInput">
            Rate RM/kWh
            <span class="right">小数键盘</span>
          </label>
          <input
            id="rateInput"
            type="text"
            inputmode="decimal"
            placeholder="1.50"
          />
        </div>
        <div class="field">
          <label for="costInput">
            Cost RM
            <span class="right">小数键盘</span>
          </label>
          <input
            id="costInput"
            type="text"
            inputmode="decimal"
            placeholder="18.90"
          />
        </div>
      </div>

      <div class="field-row">
        <button class="btn btn-soft btn-sm" id="saveLocationBtn">
          <span class="icon">＋</span> 保存地点
        </button>
        <button class="btn btn-soft btn-sm" id="deleteLocationBtn">
          <span class="icon">✕</span> 删除当前地点
        </button>
        <div style="flex:1"></div>
        <button class="btn btn-primary" id="addRecordBtn">
          <span class="icon">●</span> 保存充电记录
        </button>
      </div>
      <div class="pill-info" id="prevInfo">
        暂无历史记录。第一条记录将不会计算 KM / kWh / Wh/km。
      </div>
    </section>

    <!-- Records -->
    <section class="card records-card">
      <div class="card-header">
        <div class="card-title">Charge Log</div>
        <div class="pill">
          Date / Start / End / Used kWh / KM / Location / Rate / Cost
        </div>
      </div>
      <div class="table-wrapper" id="tableWrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Start%</th>
              <th>End%</th>
              <th>Used kWh</th>
              <th>KM</th>
              <th>Wh/km</th>
              <th>Location</th>
              <th>Rate</th>
              <th>Cost</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="recordsBody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
      <div class="empty-state" id="emptyState">
        还没有记录。上面填写一次充电数据，然后点「保存充电记录」。
      </div>
    </section>

    <!-- Monthly Summary -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Monthly Summary</div>
        <div class="pill">
          总 RM · 总 kWh · 总 KM · 平均 Wh/km
        </div>
      </div>
      <div id="summaryContainer">
        <div class="empty-state" style="padding-top:8px;">
          未产生任何月份统计。
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom bar -->
  <div class="bottom-bar">
    <div class="bottom-inner">
      <div class="bottom-group">
        <button class="btn btn-soft" id="exportBtn">
          <span class="icon">⇣</span> Export CSV
        </button>
        <button class="btn btn-soft" id="importBtn">
          <span class="icon">⇡</span> Import CSV
        </button>
      </div>
      <div class="bottom-hint">
        CSV 字段：<strong>date,start,end,odo,location,rate,cost,driveKm,usedKwh,whPerKm</strong>
      </div>
    </div>
  </div>

  <script>
    // --- Storage Keys ---
    const STORAGE_KEY_RECORDS = "evChargeLogPro_v5_records";
    const STORAGE_KEY_LOCATIONS = "evChargeLogPro_v5_locations";

    // --- DOM Elements ---
    const dateInput = document.getElementById("dateInput");
    const startPercentInput = document.getElementById("startPercent");
    const endPercentInput = document.getElementById("endPercent");
    const odoInput = document.getElementById("odoInput");
    const locationSelect = document.getElementById("locationSelect");
    const locationCustom = document.getElementById("locationCustom");
    const locationCount = document.getElementById("locationCount");
    const rateInput = document.getElementById("rateInput");
    const costInput = document.getElementById("costInput");
    const addRecordBtn = document.getElementById("addRecordBtn");
    const saveLocationBtn = document.getElementById("saveLocationBtn");
    const deleteLocationBtn = document.getElementById("deleteLocationBtn");
    const prevInfo = document.getElementById("prevInfo");

    const recordsBody = document.getElementById("recordsBody");
    const emptyState = document.getElementById("emptyState");
    const summaryContainer = document.getElementById("summaryContainer");

    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const toastEl = document.getElementById("toast");
    const tableWrapper = document.getElementById("tableWrapper");

    const importModal = document.getElementById("importModal");
    const importCancelBtn = document.getElementById("importCancelBtn");
    const importConfirmBtn = document.getElementById("importConfirmBtn");
    const fileInput = document.getElementById("fileInput");

    // --- State ---
    let records = [];
    let locations = [];
    let editingId = null; // if not null, we're editing this record

    // --- Utils ---
    function showToast(msg, duration = 2000) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, duration);
    }

    function loadState() {
      try {
        const recStr = localStorage.getItem(STORAGE_KEY_RECORDS);
        records = recStr ? JSON.parse(recStr) : [];
      } catch (e) {
        records = [];
      }
      try {
        const locStr = localStorage.getItem(STORAGE_KEY_LOCATIONS);
        locations = locStr ? JSON.parse(locStr) : [];
      } catch (e) {
        locations = [];
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
      localStorage.setItem(STORAGE_KEY_LOCATIONS, JSON.stringify(locations));
    }

    function formatNumber(num, decimals) {
      if (num === null || num === undefined || isNaN(num)) return "-";
      return Number(num).toFixed(decimals);
    }

    function defaultToday() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function updateLocationSelect() {
      locationSelect.innerHTML =
        '<option value="">选择或输入下方自定义</option>';
      locations.forEach((loc) => {
        const opt = document.createElement("option");
        opt.value = loc;
        opt.textContent = loc;
        locationSelect.appendChild(opt);
      });
      locationCount.textContent = `${locations.length} saved`;
    }

    function getSelectedLocation() {
      if (locationCustom.value.trim()) {
        return locationCustom.value.trim();
      }
      return locationSelect.value || "";
    }

    function ensureLocationExists(loc) {
      if (!loc) return;
      if (!locations.includes(loc)) {
        locations.push(loc);
        locations.sort((a, b) => a.localeCompare(b));
        updateLocationSelect();
        saveState();
      }
    }

    function getSortedRecords() {
      // sort by date then createdAt
      return [...records].sort((a, b) => {
        if (a.date === b.date) {
          return (a.createdAt || 0) - (b.createdAt || 0);
        }
        return a.date.localeCompare(b.date);
      });
    }

    function recomputeDerived() {
      const sorted = getSortedRecords();
      for (let i = 0; i < sorted.length; i++) {
        const curr = sorted[i];
        if (i === 0) {
          curr.driveKm = null;
          curr.usedKwh = null;
          curr.whPerKm = null;
        } else {
          const prev = sorted[i - 1];
          const odoCurr = Number(curr.odo);
          const odoPrev = Number(prev.odo);
          const startCurr = Number(curr.start);
          const endPrev = Number(prev.end);

          let driveKm = odoCurr - odoPrev;
          if (!isFinite(driveKm) || isNaN(driveKm) || driveKm <= 0) {
            driveKm = null;
          }

          let usedKwh = (60 * (endPrev - startCurr)) / 100;
          if (!isFinite(usedKwh) || isNaN(usedKwh) || usedKwh <= 0) {
            usedKwh = null;
          }

          let whPerKm = null;
          if (driveKm && usedKwh) {
            whPerKm = (usedKwh * 1000) / driveKm;
          }

          curr.driveKm = driveKm;
          curr.usedKwh = usedKwh;
          curr.whPerKm = whPerKm;
        }
      }
      // replace original records array with sorted
      records = sorted;
    }

    function renderPrevInfo() {
      if (!records.length) {
        prevInfo.textContent =
          "暂无历史记录。第一条记录将不会计算 KM / kWh / Wh/km。";
        return;
      }
      const last = getSortedRecords()[records.length - 1];
      prevInfo.innerHTML = `
        上一条记录：<strong>${last.date}</strong>
        · End <strong>${last.end}%</strong>
        · ODO <strong>${last.odo} km</strong>
      `;
    }

    function renderRecords() {
      recordsBody.innerHTML = "";
      const sorted = getSortedRecords();
      if (!sorted.length) {
        emptyState.style.display = "block";
        return;
      }
      emptyState.style.display = "none";

      sorted.forEach((rec) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = rec.date;

        const tdStart = document.createElement("td");
        tdStart.textContent = rec.start;

        const tdEnd = document.createElement("td");
        tdEnd.textContent = rec.end;

        const tdUsed = document.createElement("td");
        tdUsed.textContent = formatNumber(rec.usedKwh, 2);

        const tdKm = document.createElement("td");
        tdKm.textContent = rec.driveKm == null ? "-" : rec.driveKm;

        const tdWh = document.createElement("td");
        tdWh.textContent = formatNumber(rec.whPerKm, 0);

        const tdLoc = document.createElement("td");
        const locBadge = document.createElement("span");
        locBadge.className = "badge-loc";
        locBadge.textContent = rec.location || "—";
        tdLoc.appendChild(locBadge);

        const tdRate = document.createElement("td");
        tdRate.textContent =
          rec.rate === "" || rec.rate == null ? "-" : formatNumber(rec.rate, 2);

        const tdCost = document.createElement("td");
        tdCost.textContent =
          rec.cost === "" || rec.cost == null ? "-" : formatNumber(rec.cost, 2);

        const tdActions = document.createElement("td");
        const actionRow = document.createElement("div");
        actionRow.className = "action-row";

        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          loadRecordToForm(rec.id);
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "Del";
        delBtn.className = "delete";
        delBtn.addEventListener("click", () => {
          if (confirm("确定删除这条记录？")) {
            deleteRecord(rec.id);
          }
        });

        actionRow.appendChild(editBtn);
        actionRow.appendChild(delBtn);
        tdActions.appendChild(actionRow);

        tr.appendChild(tdDate);
        tr.appendChild(tdStart);
        tr.appendChild(tdEnd);
        tr.appendChild(tdUsed);
        tr.appendChild(tdKm);
        tr.appendChild(tdWh);
        tr.appendChild(tdLoc);
        tr.appendChild(tdRate);
        tr.appendChild(tdCost);
        tr.appendChild(tdActions);

        recordsBody.appendChild(tr);
      });
    }

    function renderSummary() {
      summaryContainer.innerHTML = "";
      const sorted = getSortedRecords();
      if (!sorted.length) {
        summaryContainer.innerHTML =
          '<div class="empty-state" style="padding-top:8px;">未产生任何月份统计。</div>';
        return;
      }

      const byMonth = {};
      sorted.forEach((rec) => {
        if (!rec.date) return;
        const month = rec.date.slice(0, 7); // YYYY-MM
        if (!byMonth[month]) {
          byMonth[month] = {
            totalRM: 0,
            totalKwh: 0,
            totalKm: 0,
            whSum: 0,
            whCount: 0,
          };
        }
        const bucket = byMonth[month];
        const cost = Number(rec.cost);
        const kwh = Number(rec.usedKwh);
        const km = Number(rec.driveKm);
        const wh = Number(rec.whPerKm);

        if (!isNaN(cost)) bucket.totalRM += cost;
        if (!isNaN(kwh)) bucket.totalKwh += kwh;
        if (!isNaN(km)) bucket.totalKm += km;
        if (!isNaN(wh)) {
          bucket.whSum += wh;
          bucket.whCount += 1;
        }
      });

      const months = Object.keys(byMonth).sort();
      const grid = document.createElement("div");
      grid.className = "summary-grid";

      months.forEach((month) => {
        const data = byMonth[month];
        const avgWh =
          data.whCount > 0 ? data.whSum / data.whCount : null;

        const card = document.createElement("div");
        card.className = "summary-card";

        const header = document.createElement("div");
        header.className = "summary-header";

        const mLabel = document.createElement("div");
        mLabel.className = "summary-month";
        mLabel.textContent = month;

        const kpi = document.createElement("div");
        kpi.className = "summary-kpi";
        kpi.innerHTML = `Wh/km: <strong>${
          avgWh == null ? "-" : avgWh.toFixed(0)
        }</strong>`;

        header.appendChild(mLabel);
        header.appendChild(kpi);

        const row1 = document.createElement("div");
        row1.className = "summary-row";
        row1.innerHTML = `<span>总 RM</span><span class="value">${data.totalRM.toFixed(
          2
        )}</span>`;

        const row2 = document.createElement("div");
        row2.className = "summary-row";
        row2.innerHTML = `<span>总 used kWh</span><span class="value">${data.totalKwh.toFixed(
          2
        )}</span>`;

        const row3 = document.createElement("div");
        row3.className = "summary-row";
        row3.innerHTML = `<span>总 KM</span><span class="value">${data.totalKm.toFixed(
          0
        )}</span>`;

        card.appendChild(header);
        card.appendChild(row1);
        card.appendChild(row2);
        card.appendChild(row3);

        grid.appendChild(card);
      });

      summaryContainer.appendChild(grid);
    }

    function refreshAll() {
      recomputeDerived();
      saveState();
      renderRecords();
      renderSummary();
      renderPrevInfo();
    }

    function clearForm() {
      editingId = null;
      // Keep date as last used, just clear numeric fields
      startPercentInput.value = "";
      endPercentInput.value = "";
      odoInput.value = "";
      locationCustom.value = "";
      locationSelect.value = "";
      rateInput.value = "";
      costInput.value = "";
      addRecordBtn.textContent = "● 保存充电记录";
    }

    function loadRecordToForm(id) {
      const rec = records.find((r) => r.id === id);
      if (!rec) return;
      editingId = id;
      dateInput.value = rec.date;
      startPercentInput.value = rec.start;
      endPercentInput.value = rec.end;
      odoInput.value = rec.odo;
      rateInput.value = rec.rate ?? "";
      costInput.value = rec.cost ?? "";
      locationCustom.value = rec.location || "";

      if (rec.location && locations.includes(rec.location)) {
        locationSelect.value = rec.location;
      } else {
        locationSelect.value = "";
      }

      addRecordBtn.textContent = "✔ 更新记录";
      showToast("已载入记录，可编辑后保存");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteRecord(id) {
      records = records.filter((r) => r.id !== id);
      refreshAll();
      showToast("已删除记录");
    }

    // --- Add / Update Record ---
    function handleSaveRecord() {
      const date = dateInput.value || defaultToday();
      const start = startPercentInput.value.trim();
      const end = endPercentInput.value.trim();
      const odo = odoInput.value.trim();
      const rate = rateInput.value.trim();
      const cost = costInput.value.trim();
      const location = getSelectedLocation();

      if (!start || !end || !odo) {
        showToast("Start / End / ODO 必须填写");
        return;
      }

      const startNum = Number(start);
      const endNum = Number(end);
      const odoNum = Number(odo);

      if (
        isNaN(startNum) ||
        isNaN(endNum) ||
        isNaN(odoNum) ||
        startNum < 0 ||
        startNum > 100 ||
        endNum < 0 ||
        endNum > 100
      ) {
        showToast("Start / End / ODO 数值不合法");
        return;
      }

      const rateNum = rate ? Number(rate) : null;
      const costNum = cost ? Number(cost) : null;

      if (rate && isNaN(rateNum)) {
        showToast("Rate 格式错误");
        return;
      }
      if (cost && isNaN(costNum)) {
        showToast("Cost 格式错误");
        return;
      }

      const now = Date.now();

      if (editingId) {
        const rec = records.find((r) => r.id === editingId);
        if (rec) {
          rec.date = date;
          rec.start = startNum;
          rec.end = endNum;
          rec.odo = odoNum;
          rec.rate = rateNum;
          rec.cost = costNum;
          rec.location = location;
        }
        ensureLocationExists(location);
        refreshAll();
        clearForm();
        showToast("记录已更新");
      } else {
        const newRec = {
          id: "rec_" + now + "_" + Math.random().toString(16).slice(2),
          createdAt: now,
          date,
          start: startNum,
          end: endNum,
          odo: odoNum,
          rate: rateNum,
          cost: costNum,
          location,
          driveKm: null,
          usedKwh: null,
          whPerKm: null,
        };
        records.push(newRec);
        ensureLocationExists(location);
        refreshAll();
        clearForm();
        showToast("已新增记录");
        // Scroll table to bottom
        setTimeout(() => {
          tableWrapper.scrollTop = tableWrapper.scrollHeight;
        }, 100);
      }
    }

    // --- Export CSV ---
    function exportCSV() {
      if (!records.length) {
        showToast("没有记录可导出");
        return;
      }
      const header =
        "date,start,end,odo,location,rate,cost,driveKm,usedKwh,whPerKm";
      const lines = [header];
      const sorted = getSortedRecords();
      sorted.forEach((rec) => {
        const row = [
          rec.date || "",
          rec.start ?? "",
          rec.end ?? "",
          rec.odo ?? "",
          rec.location ? `"${String(rec.location).replace(/"/g, '""')}"` : "",
          rec.rate ?? "",
          rec.cost ?? "",
          rec.driveKm ?? "",
          rec.usedKwh ?? "",
          rec.whPerKm ?? "",
        ];
        lines.push(row.join(","));
      });
      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const today = defaultToday();
      a.href = url;
      a.download = `ev_charge_log_pro_${today}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("CSV 已导出");
    }

    // --- Import CSV ---
    function openImportModal() {
      importModal.classList.add("show");
    }

    function closeImportModal() {
      importModal.classList.remove("show");
      fileInput.value = "";
    }

    function handleFileChosen(mode) {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        importCSVText(text, mode);
      };
      reader.readAsText(file);
    }

    function importCSVText(text, mode) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
      if (!lines.length) {
        showToast("CSV 内容为空");
        return;
      }
      const headerLine = lines[0];
      const headerFields = headerLine.split(",").map((h) => h.trim());
      const expectedHeader = [
        "date",
        "start",
        "end",
        "odo",
        "location",
        "rate",
        "cost",
        "driveKm",
        "usedKwh",
        "whPerKm",
      ];

      const matchesHeader =
        expectedHeader.length === headerFields.length &&
        expectedHeader.every(
          (h, idx) => h.toLowerCase() === headerFields[idx].toLowerCase()
        );

      let startIdx = 0;
      if (matchesHeader) {
        startIdx = 1;
      }

      const imported = [];
      for (let i = startIdx; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        // Basic CSV split (handles quoted location)
        const cells = [];
        let current = "";
        let inQuotes = false;
        for (let ch of line) {
          if (ch === '"') {
            inQuotes = !inQuotes;
          } else if (ch === "," && !inQuotes) {
            cells.push(current);
            current = "";
          } else {
            current += ch;
          }
        }
        cells.push(current);

        const [date, start, end, odo, location, rate, cost] = cells;

        const newRec = {
          id: "imp_" + Date.now() + "_" + i + "_" + Math.random().toString(16).slice(2),
          createdAt: Date.now() + i,
          date: date || defaultToday(),
          start: start ? Number(start) : null,
          end: end ? Number(end) : null,
          odo: odo ? Number(odo) : null,
          rate: rate ? Number(rate) : null,
          cost: cost ? Number(cost) : null,
          location: location ? location.replace(/^"|"$/g, "") : "",
          driveKm: null,
          usedKwh: null,
          whPerKm: null,
        };

        imported.push(newRec);
      }

      if (!imported.length) {
        showToast("没有有效记录被导入");
        return;
      }

      if (mode === "replace") {
        records = imported;
      } else {
        records = records.concat(imported);
      }

      // Add any new locations
      imported.forEach((rec) => {
        ensureLocationExists(rec.location);
      });

      refreshAll();
      showToast(
        `CSV 已导入 (${mode === "replace" ? "覆盖" : "追加"}) · 共 ${
          imported.length
        } 条`
      );
    }

    // --- Event Listeners ---
    document.addEventListener("DOMContentLoaded", () => {
      dateInput.value = defaultToday();
      loadState();
      updateLocationSelect();
      refreshAll();

      // Auto jump for 2-digit percent fields
      function handleAutoJump(e, nextEl) {
        const v = e.target.value.replace(/\D/g, "");
        e.target.value = v;
        if (v.length >= 2 && nextEl) {
          nextEl.focus();
          nextEl.select?.();
        }
      }
      startPercentInput.addEventListener("input", (e) =>
        handleAutoJump(e, endPercentInput)
      );
      endPercentInput.addEventListener("input", (e) =>
        handleAutoJump(e, odoInput)
      );

      // Save record
      addRecordBtn.addEventListener("click", handleSaveRecord);

      // Location manage
      saveLocationBtn.addEventListener("click", () => {
        const loc = locationCustom.value.trim();
        if (!loc) {
          showToast("请输入地点名称再保存");
          return;
        }
        ensureLocationExists(loc);
        locationSelect.value = loc;
        showToast("地点已保存");
      });

      deleteLocationBtn.addEventListener("click", () => {
        const loc = locationSelect.value || locationCustom.value.trim();
        if (!loc) {
          showToast("请选择或输入要删除的地点");
          return;
        }
        if (!locations.includes(loc)) {
          showToast("该地点不在保存列表中");
          return;
        }
        if (!confirm(`确定删除地点「${loc}」？`)) return;
        locations = locations.filter((l) => l !== loc);
        updateLocationSelect();
        saveState();
        if (locationSelect.value === loc) locationSelect.value = "";
        showToast("地点已删除");
      });

      // Export
      exportBtn.addEventListener("click", exportCSV);

      // Import
      importBtn.addEventListener("click", openImportModal);
      importCancelBtn.addEventListener("click", closeImportModal);

      importConfirmBtn.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", () => {
        const mode =
          document.querySelector('input[name="importMode"]:checked')?.value ||
          "append";
        handleFileChosen(mode);
        closeImportModal();
      });
    });
  </script>
</body>
</html>
